<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/font-awesome/css/all.min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css"><script src="/lib/pace/pace.min.js"></script><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:"blog.citysnow.cn",root:"/",scheme:"Pisces",version:"7.8.0",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!0,show_result:!0,style:"mac"},back2top:{enable:!0,sidebar:!0,scrollpercent:!0},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!0,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},path:"search.xml"}</script><meta name="description" content="第五章 Gateway–服务网关网关简介大家都都知道在微服务架构中，一个系统会被拆分为很多个微服务。那么作为客户端要如何去调用这么多的微服务呢？如果没有网关的存在，我们只能在客户端记录每个微服务的地址，然后分别去调用。"><meta property="og:type" content="article"><meta property="og:title" content="SpringCloudAlibaba（五）"><meta property="og:url" content="https://blog.citysnow.cn/2021/12/06/SpringCloudAlibaba%EF%BC%88%E4%BA%94%EF%BC%89/index.html"><meta property="og:site_name" content="城雪の博客"><meta property="og:description" content="第五章 Gateway–服务网关网关简介大家都都知道在微服务架构中，一个系统会被拆分为很多个微服务。那么作为客户端要如何去调用这么多的微服务呢？如果没有网关的存在，我们只能在客户端记录每个微服务的地址，然后分别去调用。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201181452649.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201181458016.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201181458113.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201181505484.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201181509678.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201181511227.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201181648217.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201181701472.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201181721755.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201181722359.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201181724596.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201181730977.png"><meta property="article:published_time" content="2021-12-06T08:07:13.000Z"><meta property="article:modified_time" content="2022-01-18T09:35:15.371Z"><meta property="article:author" content="城雪"><meta property="article:tag" content="Java"><meta property="article:tag" content="SpringCloud"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201181452649.png"><link rel="canonical" href="https://blog.citysnow.cn/2021/12/06/SpringCloudAlibaba%EF%BC%88%E4%BA%94%EF%BC%89/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0,lang:"zh-CN"}</script><title>SpringCloudAlibaba（五） | 城雪の博客</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span><h1 class="site-title">城雪の博客</h1><span class="logo-line-after"><i></i></span></a></div><div class="site-nav-right"><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul id="menu" class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">7</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">4</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>日志<span class="badge">15</span></a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"><input autocomplete="off" autocapitalize="off" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"><div id="no-result"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div></div></div></div></header><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content post posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://blog.citysnow.cn/2021/12/06/SpringCloudAlibaba%EF%BC%88%E4%BA%94%EF%BC%89/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202112062236308.jpg"><meta itemprop="name" content="城雪"><meta itemprop="description" content=""></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="城雪の博客"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">SpringCloudAlibaba（五）</h1><div class="post-meta"><i class="fa fa-thumb-tack"></i> <font color="7D26CD">置顶</font> <span class="post-meta-divider">|</span> <span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2021-12-06 16:07:13" itemprop="dateCreated datePublished" datetime="2021-12-06T16:07:13+08:00">2021-12-06</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2022-01-18 17:35:15" itemprop="dateModified" datetime="2022-01-18T17:35:15+08:00">2022-01-18</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" itemprop="url" rel="index"><span itemprop="name">微服务</span></a> </span></span><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span>15k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span>14 分钟</span></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="第五章-Gateway–服务网关"><a href="#第五章-Gateway–服务网关" class="headerlink" title="第五章 Gateway–服务网关"></a>第五章 Gateway–服务网关</h1><h2 id="网关简介"><a href="#网关简介" class="headerlink" title="网关简介"></a>网关简介</h2><p>大家都都知道在微服务架构中，一个系统会被拆分为很多个微服务。那么作为客户端要如何去调用这么多的微服务呢？如果没有网关的存在，我们只能在客户端记录每个微服务的地址，然后分别去调用。</p><span id="more"></span><p><img src="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201181452649.png"><br>这样的架构，会存在着诸多的问题：</p><ul><li>客户端多次请求不同的微服务，增加客户端代码或配置编写的复杂性</li><li>认证复杂，每个服务都需要独立认证。</li><li>存在跨域请求，在一定场景下处理相对复杂。</li></ul><p>上面的这些问题可以借助<strong>API网关</strong>来解决。<br>所谓的API网关，就是指系统的<strong>统一入口</strong>，它封装了应用程序的内部结构，为客户端提供统一服务，一些与业务本身功能无关的公共逻辑可以在这里实现，诸如认证、鉴权、监控、路由转发等等。<br>添加上API网关之后，系统的架构图变成了如下所示：<br><img src="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201181458016.png"><br>我们也可以观察下，我们现在的整体架构图：<br><img src="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201181458113.png"><br>在业界比较流行的网关，有下面这些：</p><ul><li>Ngnix+lua<br>使用nginx的反向代理和负载均衡可实现对api服务器的负载均衡及高可用lua是一种脚本语言,可以来编写一些简单的逻辑, nginx支持lua脚本</li><li>Kong<br>基于Nginx+Lua开发，性能高，稳定，有多个可用的插件(限流、鉴权等等)可以开箱即用。 问题：只支持Http协议；二次开发，自由扩展困难；提供管理API，缺乏更易用的管控、配置方式。</li><li>Zuul<br>Netflix开源的网关，功能丰富，使用JAVA开发，易于二次开发 问题：缺乏管控，无法动态配置；依赖组件较多；处理Http请求依赖的是Web容器，性能不如Nginx</li><li>Spring Cloud Gateway<br>Spring公司为了替换Zuul而开发的网关服务，将在下面具体介绍。</li></ul><p><strong>注意：SpringCloud alibaba技术栈中并没有提供自己的网关，我们可以采用Spring Cloud Gateway来做网关</strong></p><h2 id="Gateway简介"><a href="#Gateway简介" class="headerlink" title="Gateway简介"></a>Gateway简介</h2><p>Spring Cloud Gateway是Spring公司基于Spring 5.0，Spring Boot 2.0 和 Project Reactor 等技术开发的网关，它旨在为微服务架构提供一种简单有效的统一的 API 路由管理方式。它的目标是替代Netflix Zuul，其不仅提供统一的路由方式，并且基于 Filter 链的方式提供了网关基本的功能，例如：安全，监控和限流。<br>优点：</p><ul><li>性能强劲：是第一代网关Zuul的1.6倍</li><li>功能强大：内置了很多实用的功能，例如转发、监控、限流等</li><li>设计优雅，容易扩展</li></ul><p>缺点：</p><ul><li>其实现依赖Netty与WebFlux，不是传统的Servlet编程模型，学习成本高</li><li>不能将其部署在Tomcat、Jetty等Servlet容器里，只能打成jar包执行</li><li>需要Spring Boot 2.0及以上的版本，才支持</li></ul><h2 id="Gateway快速入门"><a href="#Gateway快速入门" class="headerlink" title="Gateway快速入门"></a>Gateway快速入门</h2><p>要求: 通过浏览器访问api网关,然后通过网关将请求转发到商品微服务</p><h3 id="基础版"><a href="#基础版" class="headerlink" title="基础版"></a>基础版</h3><ol><li>创建一个api-gateway 的模块,导入相关依赖<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="line">&lt;project xmlns=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span><br><span class="line">xmlns:xsi=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="line">xsi:schemaLocation=<span class="string">&quot;http://maven.apache.org/POM/4.0.0</span></span><br><span class="line"><span class="string">http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span><br><span class="line">    &lt;parent&gt;</span><br><span class="line">        &lt;artifactId&gt;springcloud-alibaba&lt;/artifactId&gt;</span><br><span class="line">        &lt;groupId&gt;com.itheima&lt;/groupId&gt;</span><br><span class="line">        &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;</span><br><span class="line">    &lt;/parent&gt;</span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</span><br><span class="line">    &lt;artifactId&gt;api-gateway&lt;/artifactId&gt;</span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;!--gateway网关--&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-cloud-starter-gateway&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">    &lt;/dependencies&gt;</span><br><span class="line">&lt;/project&gt;</span><br></pre></td></tr></table></figure></li><li>创建主类<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@SpringBootApplication</span><br><span class="line">public class GatewayApplication &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        SpringApplication.run(GatewayApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>添加配置文件<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">server:</span><br><span class="line">    port: 7000</span><br><span class="line">spring:</span><br><span class="line">    application:</span><br><span class="line">        name: api-gateway</span><br><span class="line">    cloud:</span><br><span class="line">        gateway:</span><br><span class="line">            routes: <span class="comment"># 路由数组[路由 就是指定当请求满足什么条件的时候转到哪个微服务]</span></span><br><span class="line">                - id: product_route <span class="comment"># 当前路由的标识, 要求唯一</span></span><br><span class="line">                uri: http://localhost:8081 <span class="comment"># 请求要转发到的地址</span></span><br><span class="line">                order: 1 <span class="comment"># 路由的优先级,数字越小级别越高</span></span><br><span class="line">                predicates: <span class="comment"># 断言(就是路由转发要满足的条件)</span></span><br><span class="line">                    - Path=/product-serv/** <span class="comment"># 当请求路径满足Path指定的规则时,才进行路由转发</span></span><br><span class="line">                filters: <span class="comment"># 过滤器,请求在传递过程中可以通过过滤器对其进行一定的修改</span></span><br><span class="line">                    - StripPrefix=1 <span class="comment"># 转发之前去掉1层路径</span></span><br></pre></td></tr></table></figure></li><li>启动项目, 并通过网关去访问微服务<br><img src="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201181505484.png"></li></ol><h3 id="增强版"><a href="#增强版" class="headerlink" title="增强版"></a>增强版</h3><p>现在在配置文件中写死了转发路径的地址, 前面我们已经分析过地址写死带来的问题, 接下来我们从注册中心获取此地址。</p><ol><li>加入nacos依赖<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--nacos客户端--&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure></li><li>在主类上添加注解<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@SpringBootApplication</span><br><span class="line">@EnableDiscoveryClient</span><br><span class="line">public class ApiGatewayApplication &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        SpringApplication.run(ApiGatewayApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>修改配置文件<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">server:</span><br><span class="line">    port: 7000</span><br><span class="line">spring:</span><br><span class="line">    application:</span><br><span class="line">        name: api-gateway</span><br><span class="line">    cloud:</span><br><span class="line">        nacos:</span><br><span class="line">            discovery:</span><br><span class="line">                server-addr: 127.0.0.1:8848</span><br><span class="line">        gateway:</span><br><span class="line">            discovery:</span><br><span class="line">                locator:</span><br><span class="line">                    enabled: <span class="literal">true</span> <span class="comment"># 让gateway可以发现nacos中的微服务</span></span><br><span class="line">            routes:</span><br><span class="line">                - id: product_route</span><br><span class="line">                    uri: lb://service-product <span class="comment"># lb指的是从nacos中按照名称获取微服务,并遵循负载均衡策略</span></span><br><span class="line">                    predicates:</span><br><span class="line">                        - Path=/product-serv/**</span><br><span class="line">                    filters:</span><br><span class="line">                        - StripPrefix=1</span><br></pre></td></tr></table></figure></li><li>测试<br><img src="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201181509678.png"></li></ol><h3 id="简写版"><a href="#简写版" class="headerlink" title="简写版"></a>简写版</h3><ol><li>去掉关于路由的配置<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">server:</span><br><span class="line">    port: 7000</span><br><span class="line">spring:</span><br><span class="line">    application:</span><br><span class="line">        name: gateway</span><br><span class="line">    cloud:</span><br><span class="line">        nacos:</span><br><span class="line">            discovery:</span><br><span class="line">                server-addr: 127.0.0.1:8848</span><br><span class="line">    gateway:</span><br><span class="line">        discovery:</span><br><span class="line">            locator:</span><br><span class="line">                enabled: <span class="literal">true</span></span><br></pre></td></tr></table></figure></li><li>启动项目，并通过网关去访问微服务<br><img src="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201181511227.png"><br>这时候，就发现只要按照<strong>网关地址/微服务/接口</strong>的格式去访问，就可以得到成功响应。</li></ol><h2 id="Gateway核心架构"><a href="#Gateway核心架构" class="headerlink" title="Gateway核心架构"></a>Gateway核心架构</h2><h3 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h3><p>路由(Route) 是 gateway 中最基本的组件之一，表示一个具体的路由信息载体。主要定义了下面的几个信息:</p><ul><li>id，路由标识符，区别于其他 Route。</li><li>uri，路由指向的目的地 uri，即客户端请求最终被转发到的微服务。</li><li>order，用于多个 Route 之间的排序，数值越小排序越靠前，匹配优先级越高。</li><li>predicate，断言的作用是进行条件判断，只有断言都返回真，才会真正的执行路由。</li><li>filter，过滤器用于修改请求和响应信息。</li></ul><h3 id="执行流程"><a href="#执行流程" class="headerlink" title="执行流程"></a>执行流程</h3><p><img src="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201181648217.png"><br>执行流程大体如下：</p><ol><li>Gateway Client向Gateway Server发送请求</li><li>请求首先会被HttpWebHandlerAdapter进行提取组装成网关上下文</li><li>然后网关的上下文会传递到DispatcherHandler，它负责将请求分发给<br>RoutePredicateHandlerMapping</li><li>RoutePredicateHandlerMapping负责路由查找，并根据路由断言判断路由是否可用</li><li>如果过断言成功，由FilteringWebHandler创建过滤器链并调用</li><li>请求会一次经过PreFilter–微服务–PostFilter的方法，最终返回响应</li></ol><h2 id="断言"><a href="#断言" class="headerlink" title="断言"></a>断言</h2><p>Predicate(断言, 谓词) 用于进行条件判断，只有断言都返回真，才会真正的执行路由。<br>断言就是说: 在 什么条件下 才能进行路由转发</p><h3 id="内置路由断言工厂"><a href="#内置路由断言工厂" class="headerlink" title="内置路由断言工厂"></a>内置路由断言工厂</h3><p>SpringCloud Gateway包括许多内置的断言工厂，所有这些断言都与HTTP请求的不同属性匹配。具体如下：</p><ul><li>基于Datetime类型的断言工厂<br>此类型的断言根据时间做判断，主要有三个：<br>AfterRoutePredicateFactory： 接收一个日期参数，判断请求日期是否晚于指定日期<br>BeforeRoutePredicateFactory： 接收一个日期参数，判断请求日期是否早于指定日期<br>BetweenRoutePredicateFactory： 接收两个日期参数，判断请求日期是否在指定时间段内<blockquote><p>-After=2019-12-31T23:59:59.789+08:00[Asia/Shanghai]</p></blockquote></li><li>基于远程地址的断言工厂 RemoteAddrRoutePredicateFactory：接收一个IP地址段，判断请求主机地址是否在地址段中<blockquote><p>-RemoteAddr=192.168.1.1/24</p></blockquote></li><li>基于Cookie的断言工厂<br>CookieRoutePredicateFactory：接收两个参数，cookie 名字和一个正则表达式。 判断请求cookie是否具有给定名称且值与正则表达式匹配。<blockquote><p>-Cookie=chocolate, ch.</p></blockquote></li><li>基于Header的断言工厂<br>HeaderRoutePredicateFactory：接收两个参数，标题名称和正则表达式。 判断请求Header是否具有给定名称且值与正则表达式匹配。<blockquote><p>-Header=X-Request-Id, \d+</p></blockquote></li><li>基于Host的断言工厂<br>HostRoutePredicateFactory：接收一个参数，主机名模式。判断请求的Host是否满足匹配规则。<blockquote><p>-Host=**.testhost.org</p></blockquote></li><li>基于Method请求方法的断言工厂<br>MethodRoutePredicateFactory：接收一个参数，判断请求类型是否跟指定的类型匹配。<blockquote><p>-Method=GET</p></blockquote></li><li>基于Path请求路径的断言工厂<br>PathRoutePredicateFactory：接收一个参数，判断请求的URI部分是否满足路径规则。<blockquote><p>-Path=/foo/{segment}</p></blockquote></li><li>基于Query请求参数的断言工厂<br>QueryRoutePredicateFactory ：接收两个参数，请求param和正则表达式， 判断请求参数是否具有给定名称且值与正则表达式匹配。<blockquote><p>-Query=baz, ba.</p></blockquote></li><li>基于路由权重的断言工厂<br>WeightRoutePredicateFactory：接收一个[组名,权重], 然后对于同一个组内的路由按照权重转发<blockquote><p>routes:</p></blockquote></li><li>id: weight_route1 uri: host1 predicates:</li><li>Path=/product/**</li><li>Weight=group3, 1</li><li>id: weight_route2 uri: host2 predicates:</li><li>Path=/product/**</li><li>Weight= group3, 9</li></ul><p><strong>内置路由断言工厂的使用</strong><br>接下来我们验证几个内置断言的使用:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">server:</span><br><span class="line">    port: 7000</span><br><span class="line">spring:</span><br><span class="line">    application:</span><br><span class="line">        name: api-gateway</span><br><span class="line">    cloud:</span><br><span class="line">        nacos:</span><br><span class="line">            discovery:</span><br><span class="line">                server-addr: 127.0.0.1:8848</span><br><span class="line">        gateway:</span><br><span class="line">            discovery:</span><br><span class="line">                locator:</span><br><span class="line">                    enabled: <span class="literal">true</span></span><br><span class="line">            routes:</span><br><span class="line">                - id: product_route</span><br><span class="line">                    uri: lb://service-product</span><br><span class="line">                    predicates:</span><br><span class="line">                        - Path=/product-serv/**</span><br><span class="line">                        - Before=2019-11-28T00:00:00.000+08:00 <span class="comment">#限制请求时间在2019-11-28之前</span></span><br><span class="line">                        - Method=POST <span class="comment">#限制请求方式为POST</span></span><br><span class="line">                    filters:</span><br><span class="line">                        - StripPrefix=1</span><br></pre></td></tr></table></figure><h3 id="自定义路由断言工厂"><a href="#自定义路由断言工厂" class="headerlink" title="自定义路由断言工厂"></a>自定义路由断言工厂</h3><p>我们来设定一个场景: 假设我们的应用仅仅让age在(min,max)之间的人来访问。</p><ol><li>在配置文件中,添加一个Age的断言配置<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">    application:</span><br><span class="line">        name: api-gateway</span><br><span class="line">    cloud:</span><br><span class="line">        nacos:</span><br><span class="line">            discovery:</span><br><span class="line">                server-addr: 127.0.0.1:8848</span><br><span class="line">        gateway:</span><br><span class="line">            discovery:</span><br><span class="line">                locator:</span><br><span class="line">                    enabled: <span class="literal">true</span></span><br><span class="line">            routes:</span><br><span class="line">                - id: product-route</span><br><span class="line">                    uri: lb://service-product</span><br><span class="line">                    predicates:</span><br><span class="line">                        - Path=/product-serv/**</span><br><span class="line">                        - Age=18,60 <span class="comment"># 限制年龄只有在18到60岁之间的人能访问</span></span><br><span class="line">                    filters:</span><br><span class="line">                        - StripPrefix=1</span><br></pre></td></tr></table></figure></li><li>自定义一个断言工厂, 实现断言方法<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">//泛型 用于接收一个配置类,配置类用于接收中配置文件中的配置</span><br><span class="line">@Component</span><br><span class="line">public class AgeRoutePredicateFactory extends AbstractRoutePredicateFactory&lt;AgeRoutePredicateFactory.Config&gt; &#123;</span><br><span class="line">    public <span class="function"><span class="title">AgeRoutePredicateFactory</span></span>() &#123;</span><br><span class="line">        super(AgeRoutePredicateFactory.Config.class);</span><br><span class="line">    &#125;</span><br><span class="line">    //用于从配置文件中获取参数值赋值到配置类中的属性上</span><br><span class="line">    @Override</span><br><span class="line">    public List&lt;String&gt; <span class="function"><span class="title">shortcutFieldOrder</span></span>() &#123;</span><br><span class="line">        //这里的顺序要跟配置文件中的参数顺序一致</span><br><span class="line">        <span class="built_in">return</span> Arrays.asList(<span class="string">&quot;minAge&quot;</span>, <span class="string">&quot;maxAge&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    //断言</span><br><span class="line">    @Override</span><br><span class="line">    public Predicate&lt;ServerWebExchange&gt; apply(AgeRoutePredicateFactory.Config config) &#123;</span><br><span class="line">        <span class="built_in">return</span> new Predicate&lt;ServerWebExchange&gt;() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public boolean <span class="built_in">test</span>(ServerWebExchange serverWebExchange) &#123;</span><br><span class="line">                //从serverWebExchange获取传入的参数</span><br><span class="line">                String ageStr = serverWebExchange.getRequest().getQueryParams().getFirst(<span class="string">&quot;age&quot;</span>);</span><br><span class="line">                <span class="keyword">if</span> (StringUtils.isNotEmpty(ageStr)) &#123;</span><br><span class="line">                    int age = Integer.parseInt(ageStr);</span><br><span class="line">                    <span class="built_in">return</span> age &gt; config.getMinAge() &amp;&amp; age &lt; config.getMaxAge();</span><br><span class="line">                &#125;</span><br><span class="line">                    <span class="built_in">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//自定义一个配置类, 用于接收配置文件中的参数</span><br><span class="line">@Data</span><br><span class="line">class Config &#123;</span><br><span class="line">    private int minAge;</span><br><span class="line">    private int maxAge;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>启动测试<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#测试发现当age在(20,60)可以访问,其它范围不能访问</span></span><br><span class="line">http://localhost:7000/product-serv/product/1?age=30</span><br><span class="line">http://localhost:7000/product-serv/product/1?age=10</span><br></pre></td></tr></table></figure></li></ol><h2 id="过滤器"><a href="#过滤器" class="headerlink" title="过滤器"></a>过滤器</h2><p>三个知识点:</p><ol><li>作用: 过滤器就是在请求的传递过程中,对请求和响应做一些手脚</li><li>生命周期: Pre Post</li><li>分类: 局部过滤器(作用在某一个路由上) 全局过滤器(作用全部路由上)<br>在Gateway中, Filter的生命周期只有两个：“pre” 和 “post”。<ul><li>PRE： 这种过滤器在请求被路由之前调用。我们可利用这种过滤器实现身份验证、在集群中选择请求的微服务、记录调试信息等。</li><li>POST：这种过滤器在路由到微服务以后执行。这种过滤器可用来为响应添加标准的HTTP Header、收集统计信息和指标、将响应从微服务发送给客户端等。<br><img src="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201181701472.png"><br>Gateway 的Filter从作用范围可分为两种: GatewayFilter与GlobalFilter。</li><li>GatewayFilter：应用到单个路由或者一个分组的路由上。</li><li>GlobalFilter：应用到所有的路由上。</li></ul></li></ol><h3 id="局部过滤器"><a href="#局部过滤器" class="headerlink" title="局部过滤器"></a>局部过滤器</h3><p>局部过滤器是针对单个路由的过滤器。</p><h4 id="内置局部过滤器"><a href="#内置局部过滤器" class="headerlink" title="内置局部过滤器"></a>内置局部过滤器</h4><p>在SpringCloud Gateway中内置了很多不同类型的网关路由过滤器。具体如下：</p><table><thead><tr><th>过滤器</th><th>工厂</th><th>作用参数</th></tr></thead><tbody><tr><td>AddRequestHeader</td><td>为原始请求添加Header</td><td>Header的名称及值</td></tr><tr><td>AddRequestParameter</td><td>为原始请求添加请求参数</td><td>参数名称及值</td></tr><tr><td>AddResponseHeader</td><td>为原始响应添加Header</td><td>Header的名称及值</td></tr><tr><td>DedupeResponseHeader</td><td>剔除响应头中重复的值</td><td>需要去重的Header名称及去重策略</td></tr><tr><td>Hystrix</td><td>为路由引入Hystrix的断路器保护</td><td>HystrixCommand 的名称</td></tr><tr><td>FallbackHeaders</td><td>为fallbackUri的请求头中添加具体的异常信息</td><td>Header的名称</td></tr><tr><td>PrefixPath</td><td>为原始请求路径添加前缀</td><td>前缀路径</td></tr><tr><td>PreserveHostHeader</td><td>为请求添加一个preserveHostHeader=true的属性，路由过滤器会检查该属性以决定是否要发送原始的Host</td><td>无</td></tr><tr><td>RequestRateLimiter</td><td>用于对请求限流，限流算法为令牌桶</td><td>keyResolver、rateLimiter、statusCode、denyEmptyKey、emptyKeyStatus</td></tr><tr><td>RedirectTo</td><td>将原始请求重定向到指定的URL</td><td>http状态码及重定向的url</td></tr><tr><td>RemoveHopByHopHeadersFilter</td><td>为原始请求删除IETF组织规定的一系列Header</td><td>默认就会启用，可以通过配置指定仅删除哪些Header</td></tr><tr><td>RemoveRequestHeader</td><td>为原始请求删除某个Header</td><td>Header名称</td></tr><tr><td>RemoveResponseHeader</td><td>为原始响应删除某个Header</td><td>Header名称</td></tr><tr><td>RewritePath</td><td>重写原始的请求路径</td><td>原始路径正则表达式以及重写后路径的正则表达式</td></tr><tr><td>RewriteResponseHeader</td><td>重写原始响应中的某个Header</td><td>Header名称，值的正则表达式，重写后的值</td></tr><tr><td>SaveSession</td><td>在转发请求之前，强制执行WebSession::save 操作</td><td>无</td></tr><tr><td>secureHeaders</td><td>为原始响应添加一系列起安全作用的响应头</td><td>无，支持修改这些安全响应头的值</td></tr><tr><td>SetPath</td><td>修改原始的请求路径</td><td>修改后的路径</td></tr><tr><td>SetResponseHeader</td><td>修改原始响应中某个Header的值</td><td>Header名称，修改后的值</td></tr><tr><td>SetStatus</td><td>修改原始响应的状态码</td><td>HTTP 状态码，可以是数字，也可以是字符串</td></tr><tr><td>StripPrefix</td><td>用于截断原始请求的路径</td><td>使用数字表示要截断的路径的数量</td></tr><tr><td>Retry</td><td>针对不同的响应进行重试</td><td>retries、statuses、methods、series</td></tr><tr><td>RequestSize</td><td>设置允许接收最大请求包的大小。如果请求包大小超过设置的值，则返回 413 Payload Too Large</td><td>请求包大小，单位为字节，默认值为5M</td></tr><tr><td>ModifyRequestBody</td><td>在转发请求之前修改原始请求体内容</td><td>修改后的请求体内容</td></tr><tr><td>ModifyResponseBody</td><td>修改原始响应体的内容</td><td>修改后的响应体内容</td></tr></tbody></table><p><strong>内置局部过滤器的使用</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">server:</span><br><span class="line">    port: 7000</span><br><span class="line">spring:</span><br><span class="line">    application:</span><br><span class="line">        name: api-gateway</span><br><span class="line">    cloud:</span><br><span class="line">        nacos:</span><br><span class="line">            discovery:</span><br><span class="line">                server-addr: localhost:8848</span><br><span class="line">        gateway:</span><br><span class="line">            discovery:</span><br><span class="line">                locator:</span><br><span class="line">                    enabled: <span class="literal">true</span></span><br><span class="line">        routes:</span><br><span class="line">            - id: product_route</span><br><span class="line">                uri: lb://service-product</span><br><span class="line">                order: 1</span><br><span class="line">                predicates:</span><br><span class="line">                    - Path=/product-serv/**</span><br><span class="line">                filters:</span><br><span class="line">                    - StripPrefix=1</span><br><span class="line">                    - SetStatus=2000 <span class="comment"># 修改返回状态</span></span><br></pre></td></tr></table></figure><h4 id="自定义局部过滤器"><a href="#自定义局部过滤器" class="headerlink" title="自定义局部过滤器"></a>自定义局部过滤器</h4><ol><li>在配置文件中,添加一个Log的过滤器配置<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">    application:</span><br><span class="line">        name: gateway</span><br><span class="line">    cloud:</span><br><span class="line">        nacos:</span><br><span class="line">            discovery:</span><br><span class="line">                server-addr: 127.0.0.1:8848</span><br><span class="line">        gateway:</span><br><span class="line">            discovery:</span><br><span class="line">                locator:</span><br><span class="line">                    enabled: <span class="literal">true</span></span><br><span class="line">        routes:</span><br><span class="line">            - id: consumer</span><br><span class="line">                order: -1</span><br><span class="line">                uri: lb://consumer</span><br><span class="line">                predicates:</span><br><span class="line">                    - Path=/consumer-serv/**</span><br><span class="line">                filters:</span><br><span class="line">                    - StripPrefix=1</span><br><span class="line">                    - Log=<span class="literal">true</span>,<span class="literal">false</span> <span class="comment"># 控制日志是否开启</span></span><br></pre></td></tr></table></figure></li><li>自定义一个过滤器工厂,实现方法<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">//自定义局部过滤器</span><br><span class="line">@Component</span><br><span class="line">public class LogGatewayFilterFactory extends AbstractGatewayFilterFactory&lt;LogGatewayFilterFactory.Config&gt; &#123;</span><br><span class="line">    //构造函数</span><br><span class="line">    public <span class="function"><span class="title">LogGatewayFilterFactory</span></span>() &#123;</span><br><span class="line">        super(LogGatewayFilterFactory.Config.class);</span><br><span class="line">    &#125;</span><br><span class="line">    //读取配置文件中的参数 赋值到 配置类中</span><br><span class="line">    @Override</span><br><span class="line">    public List&lt;String&gt; <span class="function"><span class="title">shortcutFieldOrder</span></span>() &#123;</span><br><span class="line">        <span class="built_in">return</span> Arrays.asList(<span class="string">&quot;consoleLog&quot;</span>, <span class="string">&quot;cacheLog&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    //过滤器逻辑</span><br><span class="line">    @Override</span><br><span class="line">    public GatewayFilter apply(LogGatewayFilterFactory.Config config) &#123;</span><br><span class="line">        <span class="built_in">return</span> new <span class="function"><span class="title">GatewayFilter</span></span>() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public Mono&lt;Void&gt; filter(ServerWebExchange exchange, GatewayFilterChain chain) &#123;</span><br><span class="line">                <span class="keyword">if</span> (config.isCacheLog()) &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;cacheLog已经开启了....&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (config.isConsoleLog()) &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;consoleLog已经开启了....&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="built_in">return</span> chain.filter(exchange);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    //配置类 接收配置参数</span><br><span class="line">    @Data</span><br><span class="line">    @NoArgsConstructor</span><br><span class="line">    public static class Config &#123;</span><br><span class="line">        private boolean consoleLog;</span><br><span class="line">        private boolean cacheLog;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>启动测试</li></ol><h3 id="全局过滤器"><a href="#全局过滤器" class="headerlink" title="全局过滤器"></a>全局过滤器</h3><p>全局过滤器作用于所有路由, 无需配置。通过全局过滤器可以实现对权限的统一校验，安全性验证等功能。</p><h4 id="内置全局过滤器"><a href="#内置全局过滤器" class="headerlink" title="内置全局过滤器"></a>内置全局过滤器</h4><p>SpringCloud Gateway内部也是通过一系列的内置全局过滤器对整个路由转发进行处理如下：<br><img src="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201181721755.png"></p><h4 id="自定义全局过滤器"><a href="#自定义全局过滤器" class="headerlink" title="自定义全局过滤器"></a>自定义全局过滤器</h4><p>内置的过滤器已经可以完成大部分的功能，但是对于企业开发的一些业务功能处理，还是需要我们自己编写过滤器来实现的，那么我们一起通过代码的形式自定义一个过滤器，去完成统一的权限校验。<br>开发中的鉴权逻辑：</p><ul><li>当客户端第一次请求服务时，服务端对用户进行信息认证（登录）</li><li>认证通过，将用户信息进行加密形成token，返回给客户端，作为登录凭证</li><li>以后每次请求，客户端都携带认证的token</li><li>服务端对token进行解密，判断是否有效。<br><img src="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201181722359.png"><br>如上图，对于验证用户是否已经登录鉴权的过程可以在网关统一检验。<br>检验的标准就是请求中是否携带token凭证以及token的正确性。<br>下面的我们自定义一个GlobalFilter，去校验所有请求的请求参数中是否包含“token”，如何不包含请求参数“token”则不转发路由，否则执行正常的逻辑。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">//自定义全局过滤器需要实现GlobalFilter和Ordered接口</span><br><span class="line">@Component</span><br><span class="line">public class AuthGlobalFilter implements GlobalFilter, Ordered &#123;</span><br><span class="line">    //完成判断逻辑</span><br><span class="line">    @Override</span><br><span class="line">    public Mono&lt;Void&gt; filter(ServerWebExchange exchange, GatewayFilterChain chain) &#123;</span><br><span class="line">        String token = exchange.getRequest().getQueryParams().getFirst(<span class="string">&quot;token&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(token)) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;鉴权失败&quot;</span>);</span><br><span class="line">            exchange.getResponse().setStatusCode(HttpStatus.UNAUTHORIZED);</span><br><span class="line">            <span class="built_in">return</span> exchange.getResponse().setComplete();</span><br><span class="line">        &#125;</span><br><span class="line">        //调用chain.filter继续向下游执行</span><br><span class="line">        <span class="built_in">return</span> chain.filter(exchange);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //顺序,数值越小,优先级越高</span><br><span class="line">    @Override</span><br><span class="line">    public int <span class="function"><span class="title">getOrder</span></span>() &#123;</span><br><span class="line">        <span class="built_in">return</span> 0;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h2 id="网关限流"><a href="#网关限流" class="headerlink" title="网关限流"></a>网关限流</h2><p>网关是所有请求的公共入口，所以可以在网关进行限流，而且限流的方式也很多，我们本次采用前面学过的Sentinel组件来实现网关的限流。Sentinel支持对SpringCloud Gateway、Zuul等主流网关进行限流。<br><img src="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201181724596.png"><br>从1.6.0版本开始，Sentinel提供了SpringCloud Gateway的适配模块，可以提供两种资源维度的限流：</p><ul><li>route维度：即在Spring配置文件中配置的路由条目，资源名为对应的routeId</li><li>自定义API维度：用户可以利用Sentinel提供的API来自定义一些API分组</li></ul><ol><li>导入依赖<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.alibaba.csp&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;sentinel-spring-cloud-gateway-adapter&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure></li><li>编写配置类<br>基于Sentinel 的Gateway限流是通过其提供的Filter来完成的，使用时只需注入对应的SentinelGatewayFilter实例以及 SentinelGatewayBlockExceptionHandler 实例即可。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">public class GatewayConfiguration &#123;</span><br><span class="line"></span><br><span class="line">    private final List&lt;ViewResolver&gt; viewResolvers;</span><br><span class="line">    private final ServerCodecConfigurer serverCodecConfigurer;</span><br><span class="line"></span><br><span class="line">    public GatewayConfiguration(ObjectProvider&lt;List&lt;ViewResolver&gt;&gt; viewResolversProvider,ServerCodecConfigurer serverCodecConfigurer) &#123;</span><br><span class="line">        this.viewResolvers = viewResolversProvider.getIfAvailable(Collections::emptyList);</span><br><span class="line">        this.serverCodecConfigurer = serverCodecConfigurer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 初始化一个限流的过滤器</span><br><span class="line">    @Bean</span><br><span class="line">    @Order(Ordered.HIGHEST_PRECEDENCE)</span><br><span class="line">    public GlobalFilter <span class="function"><span class="title">sentinelGatewayFilter</span></span>() &#123;</span><br><span class="line">        <span class="built_in">return</span> new SentinelGatewayFilter();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 配置初始化的限流参数</span><br><span class="line">    @PostConstruct</span><br><span class="line">    public void <span class="function"><span class="title">initGatewayRules</span></span>() &#123;</span><br><span class="line">        Set&lt;GatewayFlowRule&gt; rules = new HashSet&lt;&gt;();</span><br><span class="line">        rules.add(</span><br><span class="line">            new GatewayFlowRule(<span class="string">&quot;product_route&quot;</span>) //资源名称,对应路由id</span><br><span class="line">                .setCount(1) // 限流阈值</span><br><span class="line">                .setIntervalSec(1) // 统计时间窗口，单位是秒，默认是 1 秒</span><br><span class="line">        );</span><br><span class="line">        GatewayRuleManager.loadRules(rules);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 配置限流的异常处理器</span><br><span class="line">    @Bean</span><br><span class="line">    @Order(Ordered.HIGHEST_PRECEDENCE)</span><br><span class="line">    public SentinelGatewayBlockExceptionHandler <span class="function"><span class="title">sentinelGatewayBlockExceptionHandler</span></span>() &#123;</span><br><span class="line">            <span class="built_in">return</span> new SentinelGatewayBlockExceptionHandler(viewResolvers, serverCodecConfigurer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 自定义限流异常页面</span><br><span class="line">    @PostConstruct</span><br><span class="line">    public void <span class="function"><span class="title">initBlockHandlers</span></span>() &#123;</span><br><span class="line">        BlockRequestHandler blockRequestHandler = new <span class="function"><span class="title">BlockRequestHandler</span></span>() &#123;</span><br><span class="line">            public Mono&lt;ServerResponse&gt; handleRequest(ServerWebExchange serverWebExchange, Throwable throwable) &#123;</span><br><span class="line">                Map map = new HashMap&lt;&gt;();</span><br><span class="line">                map.put(<span class="string">&quot;code&quot;</span>, 0);</span><br><span class="line">                map.put(<span class="string">&quot;message&quot;</span>, <span class="string">&quot;接口被限流了&quot;</span>);</span><br><span class="line">                <span class="built_in">return</span> ServerResponse.status(HttpStatus.OK).contentType(MediaType.APPLICATION_JSON_UTF8).body(BodyInserters.fromObject(map));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        GatewayCallbackManager.setBlockHandler(blockRequestHandler);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>测试<br>在一秒钟内多次访问 <a target="_blank" rel="noopener" href="http://localhost:7000/product-serv/product/1">http://localhost:7000/product-serv/product/1</a> 就可以看到限流启作用了。<br><img src="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201181730977.png"></li><li>自定义API分组<br>自定义API分组是一种更细粒度的限流规则定义<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">* 配置初始化的限流参数</span><br><span class="line">*/</span><br><span class="line">@PostConstruct</span><br><span class="line">public void <span class="function"><span class="title">initGatewayRules</span></span>() &#123;</span><br><span class="line">    Set&lt;GatewayFlowRule&gt; rules = new HashSet&lt;&gt;();</span><br><span class="line">    rules.add(new GatewayFlowRule(<span class="string">&quot;product_api1&quot;</span>).setCount(1).setIntervalSec(1));</span><br><span class="line">    rules.add(new GatewayFlowRule(<span class="string">&quot;product_api2&quot;</span>).setCount(1).setIntervalSec(1));</span><br><span class="line">    GatewayRuleManager.loadRules(rules);</span><br><span class="line">&#125;</span><br><span class="line">//自定义API分组</span><br><span class="line">@PostConstruct</span><br><span class="line">private void <span class="function"><span class="title">initCustomizedApis</span></span>() &#123;</span><br><span class="line">    Set&lt;ApiDefinition&gt; definitions = new HashSet&lt;&gt;();</span><br><span class="line">        ApiDefinition api1 = new ApiDefinition(<span class="string">&quot;product_api1&quot;</span>).setPredicateItems(</span><br><span class="line">            new HashSet&lt;ApiPredicateItem&gt;() &#123;&#123;</span><br><span class="line">            // 以/product-serv/product/api1 开头的请求</span><br><span class="line">            add(new ApiPathPredicateItem().setPattern(<span class="string">&quot;/productserv/product/api1/**&quot;</span>).setMatchStrategy(SentinelGatewayConstants.URL_MATCH_STRATEGY_PREFIX));</span><br><span class="line">        &#125;&#125;</span><br><span class="line">    );</span><br><span class="line">    ApiDefinition api2 = new ApiDefinition(<span class="string">&quot;product_api2&quot;</span>).setPredicateItems(</span><br><span class="line">        new HashSet&lt;ApiPredicateItem&gt;() &#123;&#123;</span><br><span class="line">            // 以/product-serv/product/api2/demo1 完成的url路径匹配</span><br><span class="line">            add(new ApiPathPredicateItem().setPattern(<span class="string">&quot;/productserv/product/api2/demo1&quot;</span>));</span><br><span class="line">        &#125;&#125;</span><br><span class="line">    );</span><br><span class="line">    </span><br><span class="line">    definitions.add(api1);</span><br><span class="line">    definitions.add(api2);</span><br><span class="line">    GatewayApiDefinitionManager.loadApiDefinitions(definitions);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol></div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者： </strong>城雪</li><li class="post-copyright-link"><strong>本文链接：</strong> <a href="https://blog.citysnow.cn/2021/12/06/SpringCloudAlibaba%EF%BC%88%E4%BA%94%EF%BC%89/" title="SpringCloudAlibaba（五）">https://blog.citysnow.cn/2021/12/06/SpringCloudAlibaba（五）/</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><footer class="post-footer"><div class="post-tags"><a href="/tags/Java/" rel="tag"><i class="fa fa-tag"></i> Java</a> <a href="/tags/SpringCloud/" rel="tag"><i class="fa fa-tag"></i> SpringCloud</a></div><div class="post-nav"><div class="post-nav-item"><a href="/2021/12/06/SpringCloudAlibaba%EF%BC%88%E5%9B%9B%EF%BC%89/" rel="prev" title="SpringCloudAlibaba（四）"><i class="fa fa-chevron-left"></i> SpringCloudAlibaba（四）</a></div><div class="post-nav-item"><a href="/2021/12/06/SpringCloudAlibaba%EF%BC%88%E4%BA%8C%EF%BC%89/" rel="next" title="SpringCloudAlibaba（二）">SpringCloudAlibaba（二） <i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><script>window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%AC%AC%E4%BA%94%E7%AB%A0-Gateway%E2%80%93%E6%9C%8D%E5%8A%A1%E7%BD%91%E5%85%B3"><span class="nav-number">1.</span> <span class="nav-text">第五章 Gateway–服务网关</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BD%91%E5%85%B3%E7%AE%80%E4%BB%8B"><span class="nav-number">1.1.</span> <span class="nav-text">网关简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Gateway%E7%AE%80%E4%BB%8B"><span class="nav-number">1.2.</span> <span class="nav-text">Gateway简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Gateway%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8"><span class="nav-number">1.3.</span> <span class="nav-text">Gateway快速入门</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%E7%89%88"><span class="nav-number">1.3.1.</span> <span class="nav-text">基础版</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A2%9E%E5%BC%BA%E7%89%88"><span class="nav-number">1.3.2.</span> <span class="nav-text">增强版</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AE%80%E5%86%99%E7%89%88"><span class="nav-number">1.3.3.</span> <span class="nav-text">简写版</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Gateway%E6%A0%B8%E5%BF%83%E6%9E%B6%E6%9E%84"><span class="nav-number">1.4.</span> <span class="nav-text">Gateway核心架构</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="nav-number">1.4.1.</span> <span class="nav-text">基本概念</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B"><span class="nav-number">1.4.2.</span> <span class="nav-text">执行流程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%96%AD%E8%A8%80"><span class="nav-number">1.5.</span> <span class="nav-text">断言</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%85%E7%BD%AE%E8%B7%AF%E7%94%B1%E6%96%AD%E8%A8%80%E5%B7%A5%E5%8E%82"><span class="nav-number">1.5.1.</span> <span class="nav-text">内置路由断言工厂</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E8%B7%AF%E7%94%B1%E6%96%AD%E8%A8%80%E5%B7%A5%E5%8E%82"><span class="nav-number">1.5.2.</span> <span class="nav-text">自定义路由断言工厂</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="nav-number">1.6.</span> <span class="nav-text">过滤器</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B1%80%E9%83%A8%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="nav-number">1.6.1.</span> <span class="nav-text">局部过滤器</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%86%85%E7%BD%AE%E5%B1%80%E9%83%A8%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="nav-number">1.6.1.1.</span> <span class="nav-text">内置局部过滤器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E5%B1%80%E9%83%A8%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="nav-number">1.6.1.2.</span> <span class="nav-text">自定义局部过滤器</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%A8%E5%B1%80%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="nav-number">1.6.2.</span> <span class="nav-text">全局过滤器</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%86%85%E7%BD%AE%E5%85%A8%E5%B1%80%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="nav-number">1.6.2.1.</span> <span class="nav-text">内置全局过滤器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E5%85%A8%E5%B1%80%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="nav-number">1.6.2.2.</span> <span class="nav-text">自定义全局过滤器</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BD%91%E5%85%B3%E9%99%90%E6%B5%81"><span class="nav-number">1.7.</span> <span class="nav-text">网关限流</span></a></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="城雪" src="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202112062236308.jpg"><p class="site-author-name" itemprop="name">城雪</p><div class="site-description" itemprop="description"></div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">15</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">7</span> <span class="site-state-item-name">标签</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">4</span> <span class="site-state-item-name">分类</span></a></div></nav></div></div><div class="back-to-top motion-element"><i class="fa fa-arrow-up"></i> <span>0%</span></div><script type="text/javascript" charset="utf-8" src="/js/tagcloud.js"></script><script type="text/javascript" charset="utf-8" src="/js/tagcanvas.js"></script><div class="widget-wrap"><h3 class="widget-title"></h3><div id="myCanvasContainer" class="widget tagcloud"><canvas width="250" height="250" id="resCanvas"><ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/CMD/" rel="tag">CMD</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ES6/" rel="tag">ES6</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/" rel="tag">Java</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MyBatis/" rel="tag">MyBatis</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring/" rel="tag">Spring</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpringCloud/" rel="tag">SpringCloud</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vue/" rel="tag">Vue</a><span class="tag-list-count">1</span></li></ul></canvas></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2022</span> <span class="with-love"><i class="fa fa-music"></i> </span><span class="author" itemprop="copyrightHolder">城雪</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-chart-area"></i> </span><span title="站点总字数">122k</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-coffee"></i> </span><span title="站点阅读时长">1:51</span></div></div></footer></div><script src="/lib/anime.min.js"></script><script src="//cdn.jsdelivr.net/gh/theme-next/theme-next-pjax@0/pjax.min.js"></script><script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script><script>var pjax = new Pjax({
  selectors: [
    'head title',
    '#page-configurations',
    '.content-wrap',
    '.post-toc-wrap',
    '.languages',
    '#pjax'
  ],
  switches: {
    '.post-toc-wrap': Pjax.switches.innerHTML
  },
  analytics: false,
  cacheBust: false,
  scrollTo : !CONFIG.bookmark.enable
});

window.addEventListener('pjax:success', () => {
  document.querySelectorAll('script[data-pjax], script#page-configurations, #pjax script').forEach(element => {
    var code = element.text || element.textContent || element.innerHTML || '';
    var parent = element.parentNode;
    parent.removeChild(element);
    var script = document.createElement('script');
    if (element.id) {
      script.id = element.id;
    }
    if (element.className) {
      script.className = element.className;
    }
    if (element.type) {
      script.type = element.type;
    }
    if (element.src) {
      script.src = element.src;
      // Force synchronous loading of peripheral JS.
      script.async = false;
    }
    if (element.dataset.pjax !== undefined) {
      script.dataset.pjax = '';
    }
    if (code !== '') {
      script.appendChild(document.createTextNode(code));
    }
    parent.appendChild(script);
  });
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  NexT.utils.updateSidebarPosition();
});</script><script src="/js/common.js"></script><script src="/js/local-search.js"></script><div id="pjax"></div><script type="text/javascript" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script><canvas class="fireworks" style="position:fixed;left:0;top:0;z-index:1;pointer-events:none"></canvas><script src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script><script src="/js/cursor/explosion.min.js"></script></body></html>