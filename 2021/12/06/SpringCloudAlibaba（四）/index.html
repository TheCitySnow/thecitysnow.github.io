<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/font-awesome/css/all.min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css"><script src="/lib/pace/pace.min.js"></script><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:"blog.citysnow.cn",root:"/",scheme:"Pisces",version:"7.8.0",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!0,show_result:!0,style:"mac"},back2top:{enable:!0,sidebar:!0,scrollpercent:!0},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!0,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},path:"search.xml"}</script><meta name="description" content="1. 第四章 Sentinel–服务容错1.1. 高并发带来的问题在微服务架构中，我们将业务拆分成一个个的服务，服务与服务之间可以相互调用，但是由于网络原因或者自身的原因，服务并不能保证服务的100%可用，如果单个服务出现问题，调用这个服务就会出现网络延迟，此时若有大量的网络涌入，会形成任务堆积，最终导致服务瘫痪。"><meta property="og:type" content="article"><meta property="og:title" content="SpringCloudAlibaba（四）"><meta property="og:url" content="https://blog.citysnow.cn/2021/12/06/SpringCloudAlibaba%EF%BC%88%E5%9B%9B%EF%BC%89/index.html"><meta property="og:site_name" content="城雪の博客"><meta property="og:description" content="1. 第四章 Sentinel–服务容错1.1. 高并发带来的问题在微服务架构中，我们将业务拆分成一个个的服务，服务与服务之间可以相互调用，但是由于网络原因或者自身的原因，服务并不能保证服务的100%可用，如果单个服务出现问题，调用这个服务就会出现网络延迟，此时若有大量的网络涌入，会形成任务堆积，最终导致服务瘫痪。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201111342760.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201111343572.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201111344310.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201111344690.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201111345740.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201111348820.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201111351576.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201111351861.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201111352005.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201111353640.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201111355645.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201111419941.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201111420502.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201111421031.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201111421741.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201111422046.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201111424705.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201111657318.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201181319096.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201181322477.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201181323888.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201181327444.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201181327123.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201181328717.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201181329481.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201181331939.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201181416608.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201181437624.png"><meta property="article:published_time" content="2021-12-06T08:07:13.000Z"><meta property="article:modified_time" content="2022-01-18T06:51:13.768Z"><meta property="article:author" content="城雪"><meta property="article:tag" content="Java"><meta property="article:tag" content="SpringCloud"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201111342760.png"><link rel="canonical" href="https://blog.citysnow.cn/2021/12/06/SpringCloudAlibaba%EF%BC%88%E5%9B%9B%EF%BC%89/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0,lang:"zh-CN"}</script><title>SpringCloudAlibaba（四） | 城雪の博客</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span><h1 class="site-title">城雪の博客</h1><span class="logo-line-after"><i></i></span></a></div><div class="site-nav-right"><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul id="menu" class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">10</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">5</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>日志<span class="badge">22</span></a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"><input autocomplete="off" autocapitalize="off" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"><div id="no-result"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div></div></div></div></header><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content post posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://blog.citysnow.cn/2021/12/06/SpringCloudAlibaba%EF%BC%88%E5%9B%9B%EF%BC%89/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202112062236308.jpg"><meta itemprop="name" content="城雪"><meta itemprop="description" content=""></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="城雪の博客"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">SpringCloudAlibaba（四）</h1><div class="post-meta"><i class="fa fa-thumb-tack"></i> <font color="7D26CD">置顶</font> <span class="post-meta-divider">|</span> <span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2021-12-06 16:07:13" itemprop="dateCreated datePublished" datetime="2021-12-06T16:07:13+08:00">2021-12-06</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i> </span><span class="post-meta-item-text">更新于</span> <time title="修改时间：2022-01-18 14:51:13" itemprop="dateModified" datetime="2022-01-18T14:51:13+08:00">2022-01-18</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" itemprop="url" rel="index"><span itemprop="name">微服务</span></a> </span></span><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span>23k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span>21 分钟</span></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="第四章-Sentinel–服务容错">1. 第四章 Sentinel–服务容错</h1><h2 id="高并发带来的问题">1.1. 高并发带来的问题</h2><p>在微服务架构中，我们将业务拆分成一个个的服务，服务与服务之间可以相互调用，但是由于网络原因或者自身的原因，服务并不能保证服务的100%可用，如果单个服务出现问题，调用这个服务就会出现网络延迟，此时若有大量的网络涌入，会形成任务堆积，最终导致服务瘫痪。</p><span id="more"></span><p><strong>接下来，我们来模拟一个高并发的场景</strong></p><ol><li><p>编写java 代码</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">@RestController</span><br><span class="line">@Slf4j</span><br><span class="line">public class OrderController2 &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private OrderService orderService;</span><br><span class="line">    @Autowired</span><br><span class="line">    private ProductService productService;</span><br><span class="line"></span><br><span class="line">    @RequestMapping(<span class="string">&quot;/order/prod/&#123;pid&#125;&quot;</span>)</span><br><span class="line">    public Order order(@PathVariable(<span class="string">&quot;pid&quot;</span>) Integer pid) &#123;</span><br><span class="line">        log.info(<span class="string">&quot;接收到&#123;&#125;号商品的下单请求,接下来调用商品微服务查询此商品信息&quot;</span>, pid);</span><br><span class="line">        //调用商品微服务,查询商品信息</span><br><span class="line">        Product product = productService.findByPid(pid);</span><br><span class="line">        log.info(<span class="string">&quot;查询到&#123;&#125;号商品的信息,内容是:&#123;&#125;&quot;</span>, pid, JSON.toJSONString(product));</span><br><span class="line">        //模拟一次网络延时</span><br><span class="line">        try &#123;</span><br><span class="line">            Thread.sleep(100);</span><br><span class="line">        &#125; catch (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        //下单(创建订单)</span><br><span class="line">        Order order = new Order();</span><br><span class="line">        order.setUid(1);</span><br><span class="line">        order.setUsername(<span class="string">&quot;测试用户&quot;</span>);</span><br><span class="line">        order.setPid(pid);</span><br><span class="line">        order.setPname(product.getPname());</span><br><span class="line">        order.setPprice(product.getPprice());</span><br><span class="line">        order.setNumber(1);</span><br><span class="line">        //为了不产生太多垃圾数据,暂时不做订单保存</span><br><span class="line">        //orderService.createOrder(order);</span><br><span class="line">        log.info(<span class="string">&quot;创建订单成功,订单信息为&#123;&#125;&quot;</span>, JSON.toJSONString(order));</span><br><span class="line">        <span class="built_in">return</span> order;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @RequestMapping(<span class="string">&quot;/order/message&quot;</span>)</span><br><span class="line">    public String <span class="function"><span class="title">message</span></span>() &#123;</span><br><span class="line">        <span class="built_in">return</span> <span class="string">&quot;高并发下的问题测试&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>修改配置文件中tomcat的并发数</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">server:</span><br><span class="line">    port: 8091</span><br><span class="line">        tomcat:</span><br><span class="line">            max-threads: 10 <span class="comment">#tomcat的最大并发值修改为10,默认是200</span></span><br></pre></td></tr></table></figure></li><li><p>接下来使用压测工具,对请求进行压力测试<br>下载地址<a target="_blank" rel="noopener" href="https://jmeter.apache.org/">jmeter官网</a></p><ul><li>第一步：修改配置，并启动软件<br>进入bin目录,修改jmeter.properties文件中的语言支持为language=zh_CN，然后点击jmeter.bat启动软件。<br><img src="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201111342760.png"></li><li>第二步：添加线程组<br><img src="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201111343572.png"></li><li>第三步：配置线程并发数<br><img src="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201111344310.png"></li><li>第四步：添加Http取样<br><img src="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201111344690.png"></li><li>第五步：配置取样，并启动测试<br><img src="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201111345740.png"></li></ul></li><li><p>访问ｍessage方法观察效果</p></li></ol><p><strong>结论:</strong><br>此时会发现, 由于order方法囤积了大量请求, 导致ｍessage方法的访问出现了问题，这就是<strong>服务雪崩</strong>的雏形。</p><h2 id="服务雪崩效应">1.2. 服务雪崩效应</h2><p>在分布式系统中,由于网络原因或自身的原因,服务一般无法保证 100% 可用。如果一个服务出现了问题，调用这个服务就会出现线程阻塞的情况，此时若有大量的请求涌入，就会出现多条线程阻塞等待，进而导致服务瘫痪。<br>由于服务与服务之间的依赖性，故障会传播，会对整个微服务系统造成灾难性的严重后果，这就是服务故障的 “雪崩效应” 。<br><img src="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201111348820.png"><br>雪崩发生的原因多种多样，有不合理的容量设计，或者是高并发下某一个方法响应变慢，亦或是某台机器的资源耗尽。我们无法完全杜绝雪崩源头的发生，只有做好足够的容错，保证在一个服务发生问题，不会影响到其它服务的正常运行。也就是＂雪落而不雪崩＂。</p><h2 id="常见容错方案">1.3. 常见容错方案</h2><p>要防止雪崩的扩散，我们就要做好服务的容错，容错说白了就是保护自己不被猪队友拖垮的一些措施, 下面介绍常见的服务容错思路和组件。<br><strong>常见的容错思路</strong><br>常见的容错思路有隔离、超时、限流、熔断、降级这几种，下面分别介绍一下。</p><ul><li>隔离<br>它是指将系统按照一定的原则划分为若干个服务模块，各个模块之间相对独立，无强依赖。当有故<br>障发生时，能将问题和影响隔离在某个模块内部，而不扩散风险，不波及其它模块，不影响整体的<br>系统服务。常见的隔离方式有：线程池隔离和信号量隔离．<br><img src="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201111351576.png"></li><li>超时<br>在上游服务调用下游服务的时候，设置一个最大响应时间，如果超过这个时间，下游未作出反应，就断开请求，释放掉线程。<br><img src="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201111351861.png"></li><li>限流<br>限流就是限制系统的输入和输出流量已达到保护系统的目的。为了保证系统的稳固运行,一旦达到的需要限制的阈值,就需要限制流量并采取少量措施以完成限制流量的目的。<br><img src="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201111352005.png"></li><li>熔断<br>在互联网系统中，当下游服务因访问压力过大而响应变慢或失败，上游服务为了保护系统整体的可用性，可以暂时切断对下游服务的调用。这种牺牲局部，保全整体的措施就叫做熔断。<br><img src="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201111353640.png"><br>服务熔断一般有三种状态：<ul><li>熔断关闭状态（Closed）<br>服务没有故障时，熔断器所处的状态，对调用方的调用不做任何限制</li><li>熔断开启状态（Open）<br>后续对该服务接口的调用不再经过网络，直接执行本地的fallback方法</li><li>半熔断状态（Half-Open）<br>尝试恢复服务调用，允许有限的流量调用该服务，并监控调用成功率。如果成功率达到预期，则说明服务已恢复，进入熔断关闭状态；如果成功率仍旧很低，则重新进入熔断关闭状态。</li></ul></li><li>降级<br>降级其实就是为服务提供一个托底方案，一旦服务无法正常调用，就使用托底方案。<br><img src="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201111355645.png"></li></ul><p><strong>常见的容错组件</strong></p><ul><li>Hystrix<blockquote><p>Hystrix是由Netflix开源的一个延迟和容错库，用于隔离访问远程系统、服务或者第三方库，防止级联失败，从而提升系统的可用性与容错性。</p></blockquote></li><li>Resilience4J<blockquote><p>Resilicence4J一款非常轻量、简单，并且文档非常清晰、丰富的熔断工具，这也是Hystrix官方推荐的替代产品。不仅如此，Resilicence4j还原生支持Spring Boot 1.x/2.x，而且监控也支持和prometheus等多款主流产品进行整合。</p></blockquote></li><li>Sentinel<blockquote><p>Sentinel 是阿里巴巴开源的一款断路器实现，本身在阿里内部已经被大规模采用，非常稳定。</p></blockquote></li></ul><p>下面是三个组件在各方面的对比：</p><table><thead><tr><th>&nbsp;</th><th>Sentinel</th><th>Hystrix</th><th>resilience4j</th></tr></thead><tbody><tr><td>隔离策略</td><td>信号量隔离（并发线程数限流）</td><td>线程池隔离/信号量隔离</td><td>信号量隔离</td></tr><tr><td>熔断降级策略</td><td>基于响应时间、异常比率、异常数</td><td>基于异常比率</td><td>基于异常比率、响应时间</td></tr><tr><td>实时统计实现</td><td>滑动窗口（LeapArray）</td><td>滑动窗口（基于 RxJava）</td><td>Ring Bit Buffer</td></tr><tr><td>动态规则配置</td><td>支持多种数据源</td><td>支持多种数据源</td><td>有限支持</td></tr><tr><td>扩展性</td><td>多个扩展点</td><td>插件的形式</td><td>接口的形式</td></tr><tr><td>基于注解的支持</td><td>支持</td><td>支持</td><td>支持</td></tr><tr><td>限流</td><td>基于 QPS，支持基于调用关系的限流</td><td>有限的支持</td><td>Rate Limiter</td></tr><tr><td>流量整形</td><td>支持预热模式、匀速器模式、预热排队模式</td><td>不支持</td><td>简单的 Rate Limiter模式</td></tr><tr><td>系统自适应保护</td><td>支持</td><td>不支持</td><td>不支持</td></tr><tr><td>控制台</td><td>提供开箱即用的控制台，可配置规则、查看秒级监控、机器发现等</td><td>简单的监控查看</td><td>不提供控制台，可对接其它监控系统</td></tr></tbody></table><h2 id="Sentinel入门">1.4. Sentinel入门</h2><h3 id="什么是Sentinel">1.4.1. 什么是Sentinel</h3><p>Sentinel (分布式系统的流量防卫兵) 是阿里开源的一套用于<strong>服务容错</strong>的综合性解决方案。它以流量为切入点, 从<strong>流量控制</strong>、<strong>熔断降级</strong>、<strong>系统负载</strong>保护等多个维度来保护服务的稳定性。</p><p><strong>Sentinel 具有以下特征:</strong></p><ul><li>丰富的应用场景：<br>Sentinel 承接了阿里巴巴近 10 年的双十一大促流量的核心场景, 例如秒杀（即突发流量控制在系统容量可以承受的范围）、消息削峰填谷、集群流量控制、实时熔断下游不可用应用等。</li><li>完备的实时监控：<br>Sentinel 提供了实时的监控功能。通过控制台可以看到接入应用的单台机器秒级数据, 甚至 500 台以下规模的集群的汇总运行情况。</li><li>广泛的开源生态：<br>Sentinel 提供开箱即用的与其它开源框架/库的整合模块, 例如与 SpringCloud、Dubbo、gRPC 的整合。只需要引入相应的依赖并进行简单的配置即可快速地接入Sentinel。</li><li>完善的 SPI 扩展点：<br>Sentinel 提供简单易用、完善的 SPI 扩展接口。您可以通过实现扩展接口来快速地定制逻辑。例如定制规则管理、适配动态数据源等。</li></ul><p><strong>Sentinel 分为两个部分:</strong></p><ul><li>核心库（Java 客户端）不依赖任何框架/库,能够运行于所有 Java 运行时环境，同时对 Dubbo /Spring Cloud 等框架也有较好的支持。</li><li>控制台（Dashboard）基于 Spring Boot 开发，打包后可以直接运行，不需要额外的 Tomcat 等应用容器。</li></ul><h3 id="微服务集成Sentinel">1.4.2. 微服务集成Sentinel</h3><p>为微服务集成Sentinel非常简单, 只需要加入Sentinel的依赖即可</p><ol><li>在pom.xml中加入下面依赖<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-alibaba-sentinel&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">```  </span><br><span class="line">2. 编写一个Controller测试使用  </span><br><span class="line">```bash</span><br><span class="line">@RestController</span><br><span class="line">@Slf4j</span><br><span class="line">public class OrderController3 &#123;</span><br><span class="line"></span><br><span class="line">    @RequestMapping(<span class="string">&quot;/order/message1&quot;</span>)</span><br><span class="line">    public String <span class="function"><span class="title">message1</span></span>() &#123;</span><br><span class="line">        <span class="built_in">return</span> <span class="string">&quot;message1&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @RequestMapping(<span class="string">&quot;/order/message2&quot;</span>)</span><br><span class="line">    public String <span class="function"><span class="title">message2</span></span>() &#123;</span><br><span class="line">        <span class="built_in">return</span> <span class="string">&quot;message2&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">```  </span><br><span class="line"><span class="comment">### 安装Sentinel控制台  </span></span><br><span class="line">Sentinel 提供一个轻量级的控制台, 它提供机器发现、单机资源实时监控以及规则管理等功能。  </span><br><span class="line">1. [下载jar包,解压到文件夹](https://github.com/alibaba/Sentinel/releases)  </span><br><span class="line">2. 启动控制台  </span><br><span class="line">    ```bash</span><br><span class="line">    <span class="comment"># 直接使用jar命令启动项目(控制台本身是一个SpringBoot项目)</span></span><br><span class="line">    java -Dserver.port=8080 -Dcsp.sentinel.dashboard.server=localhost:8080 -</span><br><span class="line">    Dproject.name=sentinel-dashboard -jar sentinel-dashboard-1.7.0.jar</span><br><span class="line">    ```  </span><br><span class="line">3. 修改shop-order ,在里面加入有关控制台的配置  </span><br><span class="line">    ```bash</span><br><span class="line">    spring:</span><br><span class="line">        cloud:</span><br><span class="line">            sentinel:</span><br><span class="line">                transport:</span><br><span class="line">                    port: 9999 <span class="comment">#跟控制台交流的端口,随意指定一个未使用的端口即可</span></span><br><span class="line">                    dashboard: localhost:8080 <span class="comment"># 指定控制台服务的地址</span></span><br></pre></td></tr></table></figure></li><li>通过浏览器访问 <a target="_blank" rel="noopener" href="http://localhost:8080/">http://localhost:8080</a> 进入控制台 ( 默认用户名密码是 sentinel/sentinel )<br><img src="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201111419941.png"></li></ol><p><strong>补充：了解控制台的使用原理</strong><br>Sentinel的控制台其实就是一个SpringBoot编写的程序。我们需要将我们的微服务程序注册到控制台上,即在微服务中指定控制台的地址, 并且还要开启一个跟控制台传递数据的端口, 控制台也可以通过此端口调用微服务中的监控程序获取微服务的各种信息。<br><img src="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201111420502.png"></p><h3 id="实现一个接口的限流">1.4.3. 实现一个接口的限流</h3><ol><li><p>通过控制台为message1添加一个流控规则<br><img src="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201111421031.png"><br><img src="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201111421741.png"></p></li><li><p>通过控制台快速频繁访问, 观察效果<br><img src="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201111422046.png"></p></li></ol><h2 id="Sentinel的概念和功能">1.5. Sentinel的概念和功能</h2><h3 id="基本概念">1.5.1. 基本概念</h3><ul><li>资源<br>资源就是Sentinel要保护的东西<br>资源是 Sentinel 的关键概念。它可以是 Java 应用程序中的任何内容，可以是一个服务，也可以是一个方法，甚至可以是一段代码。</li><li>规则<br>规则就是用来定义如何进行保护资源的</li></ul><h3 id="重要功能">1.5.2. 重要功能</h3><p><img src="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201111424705.png"><br>Sentinel的主要功能就是容错，主要体现为下面这三个：</p><ul><li><p>流量控制<br>流量控制在网络传输中是一个常用的概念，它用于调整网络包的数据。任意时间到来的请求往往是随机不可控的，而系统的处理能力是有限的。我们需要根据系统的处理能力对流量进行控制。Sentinel 作为一个调配器，可以根据需要把随机的请求调整成合适的形状。</p></li><li><p>熔断降级<br>当检测到调用链路中某个资源出现不稳定的表现，例如请求响应时间长或异常比例升高的时候，则对这个资源的调用进行限制，让请求快速失败，避免影响到其它的资源而导致级联故障。<br>Sentinel 对这个问题采取了两种手段:</p><ul><li>通过并发线程数进行限制<br>Sentinel 通过限制资源并发线程的数量，来减少不稳定资源对其它资源的影响。当某个资源出现不稳定的情况下，例如响应时间变长，对资源的直接影响就是会造成线程数的逐步堆积。当线程数在特定资源上堆积到一定的数量之后，对该资源的新请求就会被拒绝。堆积的线程完成任务后才开始继续接收请求。</li><li>通过响应时间对资源进行降级<br>除了对并发线程数进行控制以外，Sentinel 还可以通过响应时间来快速降级不稳定的资源。当依赖的资源出现响应时间过长后，所有对该资源的访问都会被直接拒绝，直到过了指定的时间窗口之后才重新恢复。</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line">    Sentinel 和 Hystrix 的区别  </span><br><span class="line">    两者的原则是一致的, 都是当一个资源出现问题时, 让其快速失败, 不要波及到其它服务但是在限制的手段上, 确采取了完全不一样的方法:</span><br><span class="line">    Hystrix 采用的是线程池隔离的方式, 优点是做到了资源之间的隔离, 缺点是增加了线程切换的成本。</span><br><span class="line">    Sentinel 采用的是通过并发线程的数量和响应时间来对资源做限制。</span><br><span class="line">    ```  </span><br><span class="line">- 系统负载保护  </span><br><span class="line">Sentinel 同时提供系统维度的自适应保护能力。当系统负载较高的时候，如果还持续让请求进入可能会导致系统崩溃，无法响应。在集群环境下，会把本应这台机器承载的流量转发到其它的机器上去。如果这个时候其它的机器也处在一个边缘状态的时候，Sentinel 提供了对应的保护机制，让系统的入口流量和系统的负载达到一个平衡，保证系统在能力范围之内处理最多的请求。 </span><br><span class="line"></span><br><span class="line">**总之一句话: 我们需要做的事情，就是在Sentinel的资源上配置各种各样的规则，来实现各种容错的功能。**  </span><br><span class="line"></span><br><span class="line">## Sentinel规则  </span><br><span class="line"></span><br><span class="line">### 流控规则  </span><br><span class="line">流量控制，其原理是监控应用流量的QPS(每秒查询率) 或并发线程数等指标，当达到指定的阈值时对流量进行控制，以避免被瞬时的流量高峰冲垮，从而保障应用的高可用性。  </span><br><span class="line"></span><br><span class="line">1. 点击簇点链路，我们就可以看到访问过的接口地址，然后点击对应的流控按钮，进入流控规则配</span><br><span class="line">置页面。新增流控规则界面如下:  </span><br><span class="line">![](https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201111430470.png)  </span><br><span class="line">**资源名：** 唯一名称，默认是请求路径，可自定义  </span><br><span class="line">**针对来源：** 指定对哪个微服务进行限流，默认指default，意思是不区分来源，全部限制  </span><br><span class="line">**阈值类型/单机阈值：**</span><br><span class="line">    - QPS（每秒请求数量）: 当调用该接口的QPS达到阈值的时候，进行限流线程数：当调用该接口的线程数达到阈值的时候，进行限流</span><br><span class="line">    - 是否集群：暂不需要集群  </span><br><span class="line"></span><br><span class="line">接下来我们以QPS为例来研究限流规则的配置。  </span><br><span class="line"></span><br><span class="line">#### 简单配置  </span><br><span class="line">我们先做一个简单配置，设置阈值类型为QPS，单机阈值为3。即每秒请求量大于3的时候开始限流。  </span><br><span class="line">接下来，在流控规则页面就可以看到这个配置。  </span><br><span class="line">![](https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201111433402.png)  </span><br><span class="line"></span><br><span class="line">然后快速访问/order/message1 接口，观察效果。此时发现，当QPS &gt; 3的时候，服务就不能正常响应，而是返回Blocked by Sentinel (flow limiting)结果。  </span><br><span class="line">![](https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201111434325.png)  </span><br><span class="line"></span><br><span class="line">#### 配置流控模式  </span><br><span class="line">点击上面设置流控规则的编辑按钮，然后在编辑页面点击高级选项，会看到有流控模式一栏。  </span><br><span class="line">![](https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201111435001.png)  </span><br><span class="line"></span><br><span class="line">sentinel共有三种流控模式，分别是：  </span><br><span class="line">- 直接（默认）：接口达到限流条件时，开启限流  </span><br><span class="line">- 关联：当关联的资源达到限流条件时，开启限流 [适合做应用让步]  </span><br><span class="line">- 链路：当从某个接口过来的资源达到限流条件时，开启限流  </span><br><span class="line"></span><br><span class="line">下面呢分别演示三种模式：  </span><br><span class="line">**直接流控模式** </span><br><span class="line">直接流控模式是最简单的模式，当指定的接口达到限流条件时开启限流。上面案例使用的就是直接流控模式。</span><br><span class="line">**关联流控模式** </span><br><span class="line">关联流控模式指的是，当指定接口关联的接口达到限流条件时，开启对指定接口开启限流。  </span><br><span class="line"></span><br><span class="line">1. 配置限流规则, 将流控模式设置为关联，关联资源设置为的 /order/message2。  </span><br><span class="line">![](https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201111436399.png)  </span><br><span class="line"></span><br><span class="line">2. 通过postman软件向/order/message2连续发送请求，注意QPS一定要大于3  </span><br><span class="line">![](https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201111437096.png)  </span><br><span class="line"></span><br><span class="line">3. 访问/order/message1,会发现已经被限流  </span><br><span class="line">![](https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201111437988.png)  </span><br><span class="line"></span><br><span class="line">**链路流控模式**  </span><br><span class="line">链路流控模式指的是，当从某个接口过来的资源达到限流条件时，开启限流。它的功能有点类似于针对来源配置项，区别在于：**针对来源是针对上级微服务，而链路流控是针对上级接口，也就是说它的粒度更细。**   </span><br><span class="line">1.编写一个service，在里面添加一个方法message  </span><br><span class="line">```bash</span><br><span class="line">@Service</span><br><span class="line">public class OrderServiceImpl3 &#123;</span><br><span class="line"></span><br><span class="line">    @SentinelResource(&quot;message&quot;)</span><br><span class="line"></span><br><span class="line">    public void message() &#123;</span><br><span class="line">        System.out.println(&quot;message&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">```  </span><br><span class="line">2. 在Controller中声明两个方法，分别调用service中的方法message  </span><br><span class="line">```bash</span><br><span class="line">@RestController</span><br><span class="line">@Slf4j</span><br><span class="line">public class OrderController3 &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private OrderServiceImpl3 orderServiceImpl3;</span><br><span class="line"></span><br><span class="line">    @RequestMapping(&quot;/order/message1&quot;)</span><br><span class="line">        public String message1() &#123;</span><br><span class="line">        orderServiceImpl3.message();</span><br><span class="line">        return &quot;message1&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @RequestMapping(&quot;/order/message2&quot;)</span><br><span class="line">        public String message2() &#123;</span><br><span class="line">        orderServiceImpl3.message();</span><br><span class="line">        return &quot;message2&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">```  </span><br><span class="line">3. 禁止收敛URL的入口 context  </span><br></pre></td></tr></table></figure><p>从1.6.3 版本开始，Sentinel Web filter默认收敛所有URL的入口context，因此链路限流不生效。</p></li></ul><p>1.7.0 版本开始（对应SCA的2.1.1.RELEASE)，官方在CommonFilter 引入了WEB_CONTEXT_UNIFY 参数，用于控制是否收敛context。将其配置为 false 即可根据不同的URL 进行链路限流。<br>SCA 2.1.1.RELEASE之后的版本,可以通过配置spring.cloud.sentinel.web-context-unify=false即可关闭收敛<br>我们当前使用的版本是SpringCloud Alibaba 2.1.0.RELEASE，无法实现链路限流。<br>目前官方还未发布SCA 2.1.2.RELEASE，所以我们只能使用2.1.1.RELEASE，需要写代码的形式实现。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">(1) 暂时将SpringCloud Alibaba的版本调整为2.1.1.RELEASE  </span><br><span class="line">```bash</span><br><span class="line">&lt;spring-cloud-alibaba.version&gt;2.1.1.RELEASE&lt;/spring-cloud-alibaba.version&gt;</span><br><span class="line">```  </span><br><span class="line">(2) 配置文件中关闭sentinel的CommonFilter实例化  </span><br><span class="line">```bash</span><br><span class="line">spring:</span><br><span class="line">    cloud:</span><br><span class="line">        sentinel:</span><br><span class="line">            filter:</span><br><span class="line">                enabled: false</span><br></pre></td></tr></table></figure><p>(3) 添加一个配置类，自己构建CommonFilter实例</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">package com.itheima.config;</span><br><span class="line"></span><br><span class="line">import com.alibaba.csp.sentinel.adapter.servlet.CommonFilter;</span><br><span class="line">import org.springframework.boot.web.servlet.FilterRegistrationBean;</span><br><span class="line">import org.springframework.context.annotation.Bean;</span><br><span class="line">import org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line">@Configuration</span><br><span class="line">public class FilterContextConfig &#123;</span><br><span class="line"></span><br><span class="line">    @Bean</span><br><span class="line">    public FilterRegistrationBean <span class="function"><span class="title">sentinelFilterRegistration</span></span>() &#123;</span><br><span class="line">        FilterRegistrationBean registration = new FilterRegistrationBean();</span><br><span class="line">        registration.setFilter(new CommonFilter());</span><br><span class="line">        registration.addUrlPatterns(<span class="string">&quot;/*&quot;</span>);</span><br><span class="line">        // 入口资源关闭聚合</span><br><span class="line">        registration.addInitParameter(CommonFilter.WEB_CONTEXT_UNIFY, <span class="string">&quot;false&quot;</span>);</span><br><span class="line">        registration.setName(<span class="string">&quot;sentinelFilter&quot;</span>);</span><br><span class="line">        registration.setOrder(1);</span><br><span class="line">        <span class="built_in">return</span> registration;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="4"><li>控制台配置限流规则<br><img src="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201111657318.png"></li><li>分别通过/order/message1 和/order/message2 访问, 发现2没问题, 1的被限流了</li></ol><h4 id="配置流控效果">1.5.2.1. 配置流控效果</h4><ul><li>快速失败（默认）: 直接失败，抛出异常，不做任何额外的处理，是最简单的效果。</li><li>Warm Up：它从开始阈值到最大QPS阈值会有一个缓冲阶段，一开始的阈值是最大QPS阈值的1/3，然后慢慢增长，直到最大阈值，适用于将突然增大的流量转换为缓步增长的场景。</li><li>排队等待：让请求以均匀的速度通过，单机阈值为每秒通过数量，其余的排队等待； 它还会让设置一个超时时间，当请求超过超时间时间还未处理，则会被丢弃。</li></ul><h3 id="降级规则">1.5.3. 降级规则</h3><p>降级规则就是设置当满足什么条件的时候，对服务进行降级。Sentinel提供了三个衡量条件：</p><ul><li><p>平均响应时间 ：当资源的平均响应时间超过阈值（以 ms 为单位）之后，资源进入准降级状态。如果接下来 1s 内持续进入 5 个请求，它们的 RT都持续超过这个阈值，那么在接下的时间窗口（以 s 为单位）之内，就会对这个方法进行服务降级。<br><img src="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201181319096.png"></p><blockquote><p>注意 Sentinel 默认统计的 RT 上限是 4900 ms，超出此阈值的都会算作 4900 ms，若需要<br>变更此上限可以通过启动配置项 -Dcsp.sentinel.statistic.max.rt=xxx 来配置。</p></blockquote></li><li><p>异常比例：当资源的每秒异常总数占通过量的比值超过阈值之后，资源进入降级状态，即在接下的时间窗口（以 s 为单位）之内，对这个方法的调用都会自动地返回。异常比率的阈值范围是 [0.0,1.0]。</p><ol><li>首先模拟一个异常<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">int i = 0;</span><br><span class="line"></span><br><span class="line">@RequestMapping(<span class="string">&quot;/order/message2&quot;</span>)</span><br><span class="line">    public String <span class="function"><span class="title">message2</span></span>() &#123;</span><br><span class="line">        i++;</span><br><span class="line">        //异常比例为0.333</span><br><span class="line">        <span class="keyword">if</span> (i % 3 == 0)&#123;</span><br><span class="line">        throw new RuntimeException();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">return</span> <span class="string">&quot;message2&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>设置异常比例为0.25<br><img src="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201181322477.png"></li></ol></li><li><p>异常数 ：当资源近 1 分钟的异常数目超过阈值之后会进行服务降级。注意由于统计时间窗口是分<br>钟级别的，若时间窗口小于 60s，则结束熔断状态后仍可能再进入熔断状态。<br><img src="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201181323888.png"></p><blockquote><p>问题：<br>流控规则和降级规则返回的异常页面是一样的，我们怎么来区分到底是什么原因导致的呢？</p></blockquote></li></ul><h3 id="热点规则">1.5.4. 热点规则</h3><p>热点参数流控规则是一种更细粒度的流控规则, 它允许将规则具体到参数上。<br><strong>热点规则简单使用</strong></p><ol><li>编写代码<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@RequestMapping(<span class="string">&quot;/order/message3&quot;</span>)</span><br><span class="line">@SentinelResource(<span class="string">&quot;message3&quot;</span>)//注意这里必须使用这个注解标识,热点规则不生效</span><br><span class="line">public String message3(String name, Integer age) &#123;</span><br><span class="line">    <span class="built_in">return</span> name + age;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>配置热点规则<br><img src="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201181327444.png"></li><li>分别用两个参数访问,会发现只对第一个参数限流了<br><img src="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201181327123.png"></li></ol><p><strong>热点规则增强使用</strong><br>参数例外项允许对一个参数的具体值进行流控<br>编辑刚才定义的规则,增加参数例外项<br><img src="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201181328717.png"></p><h3 id="授权规则">1.5.5. 授权规则</h3><p>很多时候，我们需要根据调用来源来判断该次请求是否允许放行，这时候可以使用 Sentinel 的来源访问控制的功能。来源访问控制根据资源的请求来源（origin）限制资源是否通过：</p><ul><li>若配置白名单，则只有请求来源位于白名单内时才可通过；</li><li>若配置黑名单，则请求来源位于黑名单时不通过，其余的请求通过。<br><img src="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201181329481.png"><br>上面的资源名和授权类型不难理解，但是流控应用怎么填写呢？<blockquote><p>其实这个位置要填写的是来源标识，Sentinel提供了RequestOriginParser 接口来处理来源。<br>只要Sentinel保护的接口资源被访问，Sentinel就会调用RequestOriginParser 的实现类去解析访问来源。</p></blockquote></li></ul><ol><li>自定义来源处理规则<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@Component</span><br><span class="line">public class RequestOriginParserDefinition implements RequestOriginParser&#123;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public String parseOrigin(HttpServletRequest request) &#123;</span><br><span class="line">        String serviceName = request.getParameter(<span class="string">&quot;serviceName&quot;</span>);</span><br><span class="line">        <span class="built_in">return</span> serviceName;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>授权规则配置<br>这个配置的意思是只有serviceName=pc不能访问(黑名单)<br><img src="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201181331939.png"></li><li>访问 <a target="_blank" rel="noopener" href="http://localhost:8091/order/message1?serviceName=pc">http://localhost:8091/order/message1?serviceName=pc</a> 观察结果</li></ol><h3 id="系统规则">1.5.6. 系统规则</h3><p>系统保护规则是从应用级别的入口流量进行控制，从单台机器的总体 Load、RT、入口 QPS 、CPU使用率和线程数五个维度监控应用数据，让系统尽可能跑在最大吞吐量的同时保证系统整体的稳定性。<br>系统保护规则是应用整体维度的，而不是资源维度的，并且仅对入口流量 (进入应用的流量) 生效。</p><ul><li>Load（仅对 Linux/Unix-like 机器生效）：当系统 load1 超过阈值，且系统当前的并发线程数超过系统容量时才会触发系统保护。系统容量由系统的 maxQps * minRt 计算得出。设定参考值一般是 CPU cores * 2.5。</li><li>RT：当单台机器上所有入口流量的平均 RT 达到阈值即触发系统保护，单位是毫秒。</li><li>线程数：当单台机器上所有入口流量的并发线程数达到阈值即触发系统保护。</li><li>入口 QPS：当单台机器上所有入口流量的 QPS 达到阈值即触发系统保护。</li><li>CPU使用率：当单台机器上所有入口流量的 CPU使用率达到阈值即触发系统保护。</li></ul><p><strong>扩展: 自定义异常返回</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">//异常处理页面</span><br><span class="line">@Component</span><br><span class="line">public class ExceptionHandlerPage implements UrlBlockHandler &#123;</span><br><span class="line">    //BlockException 异常接口,包含Sentinel的五个异常</span><br><span class="line">    // FlowException 限流异常</span><br><span class="line">    // DegradeException 降级异常</span><br><span class="line">    // ParamFlowException 参数限流异常</span><br><span class="line">    // AuthorityException 授权异常</span><br><span class="line">    // SystemBlockException 系统负载异常</span><br><span class="line">    @Override</span><br><span class="line">    public void blocked(HttpServletRequest request, HttpServletResponse response, BlockException e) throws IOException &#123;</span><br><span class="line">        response.setContentType(<span class="string">&quot;application/json;charset=utf-8&quot;</span>);</span><br><span class="line">        ResponseData data = null;</span><br><span class="line">        <span class="keyword">if</span> (e instanceof FlowException) &#123;</span><br><span class="line">            data = new ResponseData(-1, <span class="string">&quot;接口被限流了...&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (e instanceof DegradeException) &#123;</span><br><span class="line">            data = new ResponseData(-2, <span class="string">&quot;接口被降级了...&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        response.getWriter().write(JSON.toJSONString(data));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@Data</span><br><span class="line">@AllArgsConstructor//全参构造</span><br><span class="line">@NoArgsConstructor//无参构造</span><br><span class="line">class ResponseData &#123;</span><br><span class="line">    private int code;</span><br><span class="line">    private String message;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="SentinelResource的使用">1.6. @SentinelResource的使用</h2><p>在定义了资源点之后，我们可以通过Dashboard来设置限流和降级策略来对资源点进行保护。同时还能通过@SentinelResource来指定出现异常时的处理策略。<br>@SentinelResource 用于定义资源，并提供可选的异常处理和 fallback 配置项。其主要参数如下:</p><table><thead><tr><th>属性</th><th>作用</th></tr></thead><tbody><tr><td>value</td><td>资源名称</td></tr><tr><td>entryType</td><td>entry类型，标记流量的方向，取值IN/OUT，默认是OUT</td></tr><tr><td>blockHandler</td><td>处理BlockException的函数名称,函数要求：<br>1.必须是 public<br>2.返回类型 参数与原方法一致<br>3.默认需和原方法在同一个类中。若希望使用其他类的函数，可配置blockHandlerClass ，并指定blockHandlerClass里面的方法。</td></tr><tr><td>blockHandlerClass</td><td>存放blockHandler的类,对应的处理函数必须static修饰。</td></tr><tr><td>fallback</td><td>用于在抛出异常的时候提供fallback处理逻辑。fallback函数可以针对所有类型的异常（除了 exceptionsToIgnore 里面排除掉的异常类型）进行处理。函数要求：<br>1.返回类型与原方法一致<br>2.参数类型需要和原方法相匹配<br>3.默认需和原方法在同一个类中。若希望使用其他类的函数，可配置fallbackClass ，并指定fallbackClass里面的方法。</td></tr><tr><td>fallbackClass</td><td>存放fallback的类。对应的处理函数必须static修饰。</td></tr><tr><td>defaultFallback</td><td>用于通用的 fallback 逻辑。默认fallback函数可以针对所有类型的异常进行处理。若同时配置了 fallback 和 defaultFallback，以fallback为准。函数要求：<br>1.返回类型与原方法一致<br>2.方法参数列表为空，或者有一个 Throwable 类型的参数。<br>3.默认需要和原方法在同一个类中。若希望使用其他类的函数，可配置fallbackClass ，并指定 fallbackClass 里面的方法。</td></tr><tr><td>exceptionsToIgnore</td><td>指定排除掉哪些异常。排除的异常不会计入异常统计，也不会进入fallback逻辑，而是原样抛出。</td></tr><tr><td>exceptionsToTrace</td><td>需要trace的异常</td></tr></tbody></table><p><strong>定义限流和降级后的处理方法</strong></p><ol><li>直接将限流和降级方法定义在方法中<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">@Service</span><br><span class="line">@Slf4j</span><br><span class="line">public class OrderServiceImpl3 &#123;</span><br><span class="line">    int i = 0;</span><br><span class="line"></span><br><span class="line">    @SentinelResource(</span><br><span class="line">        value = <span class="string">&quot;message&quot;</span>,</span><br><span class="line">        blockHandler = <span class="string">&quot;blockHandler&quot;</span>,//指定发生BlockException时进入的方法</span><br><span class="line">        fallback = <span class="string">&quot;fallback&quot;</span>//指定发生Throwable时进入的方法</span><br><span class="line">    )</span><br><span class="line">    public String <span class="function"><span class="title">message</span></span>() &#123;</span><br><span class="line">        i++;</span><br><span class="line">        <span class="keyword">if</span> (i % 3 == 0) &#123;</span><br><span class="line">            throw new RuntimeException();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">return</span> <span class="string">&quot;message&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //BlockException时进入的方法</span><br><span class="line">    public String blockHandler(BlockException ex) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;&#123;&#125;&quot;</span>, ex);</span><br><span class="line">        <span class="built_in">return</span> <span class="string">&quot;接口被限流或者降级了...&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //Throwable时进入的方法</span><br><span class="line">    public String fallback(Throwable throwable) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;&#123;&#125;&quot;</span>, throwable);</span><br><span class="line">        <span class="built_in">return</span> <span class="string">&quot;接口发生异常了...&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>将限流和降级方法外置到单独的类中<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">@Service</span><br><span class="line">@Slf4j</span><br><span class="line">public class OrderServiceImpl3 &#123;</span><br><span class="line"></span><br><span class="line">    int i = 0;</span><br><span class="line"></span><br><span class="line">    @SentinelResource(</span><br><span class="line">        value = <span class="string">&quot;message&quot;</span>,</span><br><span class="line">        blockHandlerClass = OrderServiceImpl3BlockHandlerClass.class,</span><br><span class="line">        blockHandler = <span class="string">&quot;blockHandler&quot;</span>,</span><br><span class="line">        fallbackClass = OrderServiceImpl3FallbackClass.class,</span><br><span class="line">        fallback = <span class="string">&quot;fallback&quot;</span></span><br><span class="line">    )</span><br><span class="line">    public String <span class="function"><span class="title">message</span></span>() &#123;</span><br><span class="line">        i++;</span><br><span class="line">        <span class="keyword">if</span> (i % 3 == 0) &#123;</span><br><span class="line">            throw new RuntimeException();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">return</span> <span class="string">&quot;message4&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">public class OrderServiceImpl3BlockHandlerClass &#123;</span><br><span class="line"></span><br><span class="line">    //注意这里必须使用static修饰方法</span><br><span class="line">    public static String blockHandler(BlockException ex) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;&#123;&#125;&quot;</span>, ex);</span><br><span class="line">        <span class="built_in">return</span> <span class="string">&quot;接口被限流或者降级了...&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@Slf4j</span><br><span class="line">public class OrderServiceImpl3FallbackClass &#123;</span><br><span class="line"></span><br><span class="line">    //注意这里必须使用static修饰方法</span><br><span class="line">    public static String fallback(Throwable throwable) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;&#123;&#125;&quot;</span>, throwable);</span><br><span class="line">        <span class="built_in">return</span> <span class="string">&quot;接口发生异常了...&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h2 id="Sentinel规则持久化">1.7. Sentinel规则持久化</h2><p>通过前面的讲解，我们已经知道，可以通过Dashboard来为每个Sentinel客户端设置各种各样的规则，但是这里有一个问题，就是这些规则默认是存放在内存中，极不稳定，所以需要将其持久化。<br>本地文件数据源会定时轮询文件的变更，读取规则。这样我们既可以在应用本地直接修改文件来更新规则，也可以通过 Sentinel 控制台推送规则。以本地文件数据源为例，推送过程如下图所示：<br><img src="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201181416608.png"><br>首先 Sentinel 控制台通过 API 将规则推送至客户端并更新到内存中，接着注册的写数据源会将新的规则保存到本地的文件中。</p><ol><li><p>编写处理类</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">//规则持久化</span><br><span class="line">public class FilePersistence implements InitFunc &#123;</span><br><span class="line"></span><br><span class="line">    @Value(<span class="string">&quot;spring.application:name&quot;</span>)</span><br><span class="line">    private String appcationName;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void init() throws Exception &#123;</span><br><span class="line">        String ruleDir = System.getProperty(<span class="string">&quot;user.home&quot;</span>) + <span class="string">&quot;/sentinelrules/&quot;</span> + appcationName;</span><br><span class="line">        String flowRulePath = ruleDir + <span class="string">&quot;/flow-rule.json&quot;</span>;</span><br><span class="line">        String degradeRulePath = ruleDir + <span class="string">&quot;/degrade-rule.json&quot;</span>;</span><br><span class="line">        String systemRulePath = ruleDir + <span class="string">&quot;/system-rule.json&quot;</span>;</span><br><span class="line">        String authorityRulePath = ruleDir + <span class="string">&quot;/authority-rule.json&quot;</span>;</span><br><span class="line">        String paramFlowRulePath = ruleDir + <span class="string">&quot;/param-flow-rule.json&quot;</span>;</span><br><span class="line">        this.mkdirIfNotExits(ruleDir);</span><br><span class="line">        this.createFileIfNotExits(flowRulePath);</span><br><span class="line">        this.createFileIfNotExits(degradeRulePath);</span><br><span class="line">        this.createFileIfNotExits(systemRulePath);</span><br><span class="line">        this.createFileIfNotExits(authorityRulePath);</span><br><span class="line">        this.createFileIfNotExits(paramFlowRulePath);</span><br><span class="line">        // 流控规则</span><br><span class="line">        ReadableDataSource&lt;String, List&lt;FlowRule&gt;&gt; flowRuleRDS = new FileRefreshableDataSource&lt;&gt;(</span><br><span class="line">            flowRulePath,</span><br><span class="line">            flowRuleListParser</span><br><span class="line">        );</span><br><span class="line">        FlowRuleManager.register2Property(flowRuleRDS.getProperty());</span><br><span class="line">        WritableDataSource&lt;List&lt;FlowRule&gt;&gt; flowRuleWDS = new FileWritableDataSource&lt;&gt;(</span><br><span class="line">            flowRulePath,</span><br><span class="line">            this::encodeJson</span><br><span class="line">        );</span><br><span class="line">        WritableDataSourceRegistry.registerFlowDataSource(flowRuleWDS);</span><br><span class="line"></span><br><span class="line">        // 降级规则</span><br><span class="line">        ReadableDataSource&lt;String, List&lt;DegradeRule&gt;&gt; degradeRuleRDS = new FileRefreshableDataSource&lt;&gt;(degradeRulePath,degradeRuleListParser);</span><br><span class="line">        DegradeRuleManager.register2Property(degradeRuleRDS.getProperty());</span><br><span class="line">        WritableDataSource&lt;List&lt;DegradeRule&gt;&gt; degradeRuleWDS = new FileWritableDataSource&lt;&gt;(degradeRulePath,this::encodeJson);</span><br><span class="line">        WritableDataSourceRegistry.registerDegradeDataSource(degradeRuleWDS);</span><br><span class="line"></span><br><span class="line">        // 系统规则</span><br><span class="line">        ReadableDataSource&lt;String, List&lt;SystemRule&gt;&gt; systemRuleRDS = new FileRefreshableDataSource&lt;&gt;(systemRulePath,systemRuleListParser);</span><br><span class="line">        SystemRuleManager.register2Property(systemRuleRDS.getProperty());</span><br><span class="line">        WritableDataSource&lt;List&lt;SystemRule&gt;&gt; systemRuleWDS = new FileWritableDataSource&lt;&gt;(systemRulePath,this::encodeJson);</span><br><span class="line">        WritableDataSourceRegistry.registerSystemDataSource(systemRuleWDS);</span><br><span class="line"></span><br><span class="line">        // 授权规则</span><br><span class="line">        ReadableDataSource&lt;String, List&lt;AuthorityRule&gt;&gt; authorityRuleRDS = new FileRefreshableDataSource&lt;&gt;(authorityRulePath,authorityRuleListParser);</span><br><span class="line">        AuthorityRuleManager.register2Property(authorityRuleRDS.getProperty());</span><br><span class="line">        WritableDataSource&lt;List&lt;AuthorityRule&gt;&gt; authorityRuleWDS = new FileWritableDataSource&lt;&gt;(authorityRulePath,this::encodeJson);</span><br><span class="line">        WritableDataSourceRegistry.registerAuthorityDataSource(authorityRuleWDS);</span><br><span class="line"></span><br><span class="line">        // 热点参数规则</span><br><span class="line">        ReadableDataSource&lt;String, List&lt;ParamFlowRule&gt;&gt; paramFlowRuleRDS = new FileRefreshableDataSource&lt;&gt;(paramFlowRulePath,paramFlowRuleListParser);</span><br><span class="line">        ParamFlowRuleManager.register2Property(paramFlowRuleRDS.getProperty());</span><br><span class="line">        WritableDataSource&lt;List&lt;ParamFlowRule&gt;&gt; paramFlowRuleWDS = new FileWritableDataSource&lt;&gt;(paramFlowRulePath,this::encodeJson);</span><br><span class="line">        ModifyParamFlowRulesCommandHandler.setWritableDataSource(paramFlowRuleWDS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private Converter&lt;String, List&lt;FlowRule&gt;&gt; flowRuleListParser = <span class="built_in">source</span> -&gt; JSON.parseObject(<span class="built_in">source</span>,new TypeReference&lt;List&lt;FlowRule&gt;&gt;() &#123;</span><br><span class="line"></span><br><span class="line">    &#125;);</span><br><span class="line">    private Converter&lt;String, List&lt;DegradeRule&gt;&gt; degradeRuleListParser = <span class="built_in">source</span> -&gt; JSON.parseObject(<span class="built_in">source</span>,new TypeReference&lt;List&lt;DegradeRule&gt;&gt;() &#123;</span><br><span class="line"></span><br><span class="line">    &#125;);</span><br><span class="line">    private Converter&lt;String, List&lt;SystemRule&gt;&gt; systemRuleListParser = <span class="built_in">source</span> -&gt; JSON.parseObject(<span class="built_in">source</span>,new TypeReference&lt;List&lt;SystemRule&gt;&gt;() &#123;</span><br><span class="line"></span><br><span class="line">    &#125;);</span><br><span class="line">    private Converter&lt;String, List&lt;AuthorityRule&gt;&gt; authorityRuleListParser = <span class="built_in">source</span> -&gt; JSON.parseObject(<span class="built_in">source</span>,new TypeReference&lt;List&lt;AuthorityRule&gt;&gt;() &#123;</span><br><span class="line">    </span><br><span class="line">    &#125;);</span><br><span class="line">    private Converter&lt;String, List&lt;ParamFlowRule&gt;&gt; paramFlowRuleListParser = <span class="built_in">source</span> -&gt; JSON.parseObject(<span class="built_in">source</span>,new TypeReference&lt;List&lt;ParamFlowRule&gt;&gt;() &#123;</span><br><span class="line">    </span><br><span class="line">    &#125;);</span><br><span class="line">    private void mkdirIfNotExits(String filePath) throws IOException &#123;</span><br><span class="line">        File file = new File(filePath);</span><br><span class="line">        <span class="keyword">if</span> (!file.exists()) &#123;</span><br><span class="line">            file.mkdirs();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    private void createFileIfNotExits(String filePath) throws IOException &#123;</span><br><span class="line">        File file = new File(filePath);</span><br><span class="line">        <span class="keyword">if</span> (!file.exists()) &#123;</span><br><span class="line">            file.createNewFile();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    private &lt;T&gt; String encodeJson(T t) &#123;</span><br><span class="line">        <span class="built_in">return</span> JSON.toJSONString(t);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>添加配置<br>在resources下创建配置目录META-INF/services ,然后添加文件com.alibaba.csp.sentinel.init.InitFunc<br>在文件中添加配置类的全路径</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">com.itheima.config.FilePersistence</span><br></pre></td></tr></table></figure></li></ol><h2 id="Feign整合Sentinel">1.8. Feign整合Sentinel</h2><ol><li>引入sentinel的依赖<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--sentinel客户端--&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-cloud-starter-alibaba-sentinel&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure></li><li>在配置文件中开启Feign对Sentinel的支持<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">feign:</span><br><span class="line">    sentinel:</span><br><span class="line">        enabled: <span class="literal">true</span></span><br></pre></td></tr></table></figure></li><li>创建容错类<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">//容错类要求必须实现被容错的接口,并为每个方法实现容错方案</span><br><span class="line">@Component</span><br><span class="line">@Slf4j</span><br><span class="line">public class ProductServiceFallBack implements ProductService &#123;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Product findByPid(Integer pid) &#123;</span><br><span class="line">        Product product = new Product();</span><br><span class="line">        product.setPid(-1);</span><br><span class="line">        <span class="built_in">return</span> product;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>为被容器的接口指定容错类<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">//value用于指定调用nacos下哪个微服务</span><br><span class="line">//fallback用于指定容错类</span><br><span class="line">@FeignClient(value = <span class="string">&quot;service-product&quot;</span>, fallback = ProductServiceFallBack.class)</span><br><span class="line">public interface ProductService &#123;</span><br><span class="line">    @RequestMapping(<span class="string">&quot;/product/&#123;pid&#125;&quot;</span>)//指定请求的URI部分</span><br><span class="line">    Product findByPid(@PathVariable Integer pid);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>修改controller<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">@RestController</span><br><span class="line">@Slf4j</span><br><span class="line">public class OrderController &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private OrderService orderService;</span><br><span class="line">    @Autowired</span><br><span class="line">    private ProductService productService;</span><br><span class="line"></span><br><span class="line">    //下单--fegin</span><br><span class="line">    @RequestMapping(<span class="string">&quot;/order/prod/&#123;pid&#125;&quot;</span>)</span><br><span class="line">    public Order order(@PathVariable(<span class="string">&quot;pid&quot;</span>) Integer pid) &#123;</span><br><span class="line">        log.info(<span class="string">&quot;接收到&#123;&#125;号商品的下单请求,接下来调用商品微服务查询此商品信息&quot;</span>, pid);</span><br><span class="line">        //调用商品微服务,查询商品信息</span><br><span class="line">        Product product = productService.findByPid(pid);</span><br><span class="line">        <span class="keyword">if</span> (product.getPid() == -1) &#123;</span><br><span class="line">            Order order = new Order();</span><br><span class="line">            order.setPname(<span class="string">&quot;下单失败&quot;</span>);</span><br><span class="line">            <span class="built_in">return</span> order;</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(<span class="string">&quot;查询到&#123;&#125;号商品的信息,内容是:&#123;&#125;&quot;</span>, pid, JSON.toJSONString(product));</span><br><span class="line">        //下单(创建订单)</span><br><span class="line">        Order order = new Order();</span><br><span class="line">        order.setUid(1);</span><br><span class="line">        order.setUsername(<span class="string">&quot;测试用户&quot;</span>);</span><br><span class="line">        order.setPid(pid);</span><br><span class="line">        order.setPname(product.getPname());</span><br><span class="line">        order.setPprice(product.getPprice());</span><br><span class="line">        order.setNumber(1);</span><br><span class="line">        orderService.createOrder(order);</span><br><span class="line">        log.info(<span class="string">&quot;创建订单成功,订单信息为&#123;&#125;&quot;</span>, JSON.toJSONString(order));</span><br><span class="line">        try &#123;</span><br><span class="line">            Thread.sleep(100);</span><br><span class="line">        &#125; catch (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">return</span> order;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>停止所有shop-product 服务,重启shop-order 服务,访问请求,观察容错效果<br><img src="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201181437624.png"></li></ol><p><strong>扩展</strong>: 如果想在容错类中拿到具体的错误,可以使用下面的方式</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@FeignClient(</span><br><span class="line">    value = <span class="string">&quot;service-product&quot;</span>,</span><br><span class="line">    //fallback = ProductServiceFallBack.class,</span><br><span class="line">    fallbackFactory = ProductServiceFallBackFactory.class)</span><br><span class="line">public interface ProductService &#123;</span><br><span class="line">    //@FeignClient的value + @RequestMapping的value值 其实就是完成的请求地址 <span class="string">&quot;http://service-product/product/&quot;</span> + pid</span><br><span class="line">    @RequestMapping(<span class="string">&quot;/product/&#123;pid&#125;&quot;</span>)//指定请求的URI部分</span><br><span class="line">    Product findByPid(@PathVariable Integer pid);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">@Component</span><br><span class="line">public class ProductServiceFallBackFactory implements FallbackFactory&lt;ProductService&gt; &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public ProductService create(Throwable throwable) &#123;</span><br><span class="line">        <span class="built_in">return</span> new <span class="function"><span class="title">ProductService</span></span>() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public Product findByPid(Integer pid) &#123;</span><br><span class="line">                throwable.printStackTrace();</span><br><span class="line">                Product product = new Product();</span><br><span class="line">                product.setPid(-1);</span><br><span class="line">                <span class="built_in">return</span> product;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>注意: fallback和fallbackFactory只能使用其中一种方式</strong></p></div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者： </strong>城雪</li><li class="post-copyright-link"><strong>本文链接：</strong> <a href="https://blog.citysnow.cn/2021/12/06/SpringCloudAlibaba%EF%BC%88%E5%9B%9B%EF%BC%89/" title="SpringCloudAlibaba（四）">https://blog.citysnow.cn/2021/12/06/SpringCloudAlibaba（四）/</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><footer class="post-footer"><div class="post-tags"><a href="/tags/Java/" rel="tag"><i class="fa fa-tag"></i> Java</a> <a href="/tags/SpringCloud/" rel="tag"><i class="fa fa-tag"></i> SpringCloud</a></div><div class="post-nav"><div class="post-nav-item"><a href="/2021/12/06/Windows%E7%BB%88%E7%AB%AF%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/" rel="prev" title="Windows终端常用命令"><i class="fa fa-chevron-left"></i> Windows终端常用命令</a></div><div class="post-nav-item"><a href="/2021/12/06/SpringCloudAlibaba%EF%BC%88%E5%85%AD%EF%BC%89/" rel="next" title="SpringCloudAlibaba（六）">SpringCloudAlibaba（六） <i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><script>window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%AC%AC%E5%9B%9B%E7%AB%A0-Sentinel%E2%80%93%E6%9C%8D%E5%8A%A1%E5%AE%B9%E9%94%99"><span class="nav-text">1. 第四章 Sentinel–服务容错</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%AB%98%E5%B9%B6%E5%8F%91%E5%B8%A6%E6%9D%A5%E7%9A%84%E9%97%AE%E9%A2%98"><span class="nav-text">1.1. 高并发带来的问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%8D%E5%8A%A1%E9%9B%AA%E5%B4%A9%E6%95%88%E5%BA%94"><span class="nav-text">1.2. 服务雪崩效应</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E5%AE%B9%E9%94%99%E6%96%B9%E6%A1%88"><span class="nav-text">1.3. 常见容错方案</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Sentinel%E5%85%A5%E9%97%A8"><span class="nav-text">1.4. Sentinel入门</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFSentinel"><span class="nav-text">1.4.1. 什么是Sentinel</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E9%9B%86%E6%88%90Sentinel"><span class="nav-text">1.4.2. 微服务集成Sentinel</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0%E4%B8%80%E4%B8%AA%E6%8E%A5%E5%8F%A3%E7%9A%84%E9%99%90%E6%B5%81"><span class="nav-text">1.4.3. 实现一个接口的限流</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Sentinel%E7%9A%84%E6%A6%82%E5%BF%B5%E5%92%8C%E5%8A%9F%E8%83%BD"><span class="nav-text">1.5. Sentinel的概念和功能</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="nav-text">1.5.1. 基本概念</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%87%8D%E8%A6%81%E5%8A%9F%E8%83%BD"><span class="nav-text">1.5.2. 重要功能</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E6%B5%81%E6%8E%A7%E6%95%88%E6%9E%9C"><span class="nav-text">1.5.2.1. 配置流控效果</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%99%8D%E7%BA%A7%E8%A7%84%E5%88%99"><span class="nav-text">1.5.3. 降级规则</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%83%AD%E7%82%B9%E8%A7%84%E5%88%99"><span class="nav-text">1.5.4. 热点规则</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8E%88%E6%9D%83%E8%A7%84%E5%88%99"><span class="nav-text">1.5.5. 授权规则</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%B3%BB%E7%BB%9F%E8%A7%84%E5%88%99"><span class="nav-text">1.5.6. 系统规则</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SentinelResource%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-text">1.6. @SentinelResource的使用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Sentinel%E8%A7%84%E5%88%99%E6%8C%81%E4%B9%85%E5%8C%96"><span class="nav-text">1.7. Sentinel规则持久化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Feign%E6%95%B4%E5%90%88Sentinel"><span class="nav-text">1.8. Feign整合Sentinel</span></a></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="城雪" src="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202112062236308.jpg"><p class="site-author-name" itemprop="name">城雪</p><div class="site-description" itemprop="description"></div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">22</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">10</span> <span class="site-state-item-name">标签</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">5</span> <span class="site-state-item-name">分类</span></a></div></nav></div></div><div class="back-to-top motion-element"><i class="fa fa-arrow-up"></i> <span>0%</span></div><script type="text/javascript" charset="utf-8" src="/js/tagcloud.js"></script><script type="text/javascript" charset="utf-8" src="/js/tagcanvas.js"></script><div class="widget-wrap"><h3 class="widget-title"></h3><div id="myCanvasContainer" class="widget tagcloud"><canvas width="250" height="250" id="resCanvas"><ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/CMD/" rel="tag">CMD</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ES6/" rel="tag">ES6</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/" rel="tag">Java</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MyBatis/" rel="tag">MyBatis</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mysql/" rel="tag">Mysql</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring/" rel="tag">Spring</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpringCloud/" rel="tag">SpringCloud</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vue/" rel="tag">Vue</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" rel="tag">多线程</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AE%9D%E5%A1%94%E9%9D%A2%E6%9D%BF/" rel="tag">宝塔面板</a><span class="tag-list-count">1</span></li></ul></canvas></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2022</span> <span class="with-love"><i class="fa fa-music"></i> </span><span class="author" itemprop="copyrightHolder">城雪</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-chart-area"></i> </span><span title="站点总字数">168k</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-coffee"></i> </span><span title="站点阅读时长">2:33</span></div></div></footer></div><script src="/lib/anime.min.js"></script><script src="//cdn.jsdelivr.net/gh/theme-next/theme-next-pjax@0/pjax.min.js"></script><script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script><script>var pjax = new Pjax({
  selectors: [
    'head title',
    '#page-configurations',
    '.content-wrap',
    '.post-toc-wrap',
    '.languages',
    '#pjax'
  ],
  switches: {
    '.post-toc-wrap': Pjax.switches.innerHTML
  },
  analytics: false,
  cacheBust: false,
  scrollTo : !CONFIG.bookmark.enable
});

window.addEventListener('pjax:success', () => {
  document.querySelectorAll('script[data-pjax], script#page-configurations, #pjax script').forEach(element => {
    var code = element.text || element.textContent || element.innerHTML || '';
    var parent = element.parentNode;
    parent.removeChild(element);
    var script = document.createElement('script');
    if (element.id) {
      script.id = element.id;
    }
    if (element.className) {
      script.className = element.className;
    }
    if (element.type) {
      script.type = element.type;
    }
    if (element.src) {
      script.src = element.src;
      // Force synchronous loading of peripheral JS.
      script.async = false;
    }
    if (element.dataset.pjax !== undefined) {
      script.dataset.pjax = '';
    }
    if (code !== '') {
      script.appendChild(document.createTextNode(code));
    }
    parent.appendChild(script);
  });
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  NexT.utils.updateSidebarPosition();
});</script><script src="/js/common.js"></script><script src="/js/local-search.js"></script><div id="pjax"></div><script color="64, 64, 64" type="text/javascript" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script><canvas class="fireworks" style="position:fixed;left:0;top:0;z-index:1;pointer-events:none"></canvas><script src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script><script src="/js/cursor/explosion.min.js"></script></body></html>