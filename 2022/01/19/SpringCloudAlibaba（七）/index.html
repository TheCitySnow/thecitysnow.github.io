<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/font-awesome/css/all.min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css"><script src="/lib/pace/pace.min.js"></script><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:"blog.citysnow.cn",root:"/",scheme:"Pisces",version:"7.8.0",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!0,show_result:!0,style:"mac"},back2top:{enable:!0,sidebar:!0,scrollpercent:!0},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!0,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},path:"search.xml"}</script><meta name="description" content="1. Rocketmq–消息驱动1.1. MQ简介1.1.1. 什么是MQMQ（Message Queue）是一种跨进程的通信机制，用于传递消息。通俗点说，就是一个先进先出的数据结构。"><meta property="og:type" content="article"><meta property="og:title" content="SpringCloudAlibaba（七）"><meta property="og:url" content="https://blog.citysnow.cn/2022/01/19/SpringCloudAlibaba%EF%BC%88%E4%B8%83%EF%BC%89/index.html"><meta property="og:site_name" content="城雪の博客"><meta property="og:description" content="1. Rocketmq–消息驱动1.1. MQ简介1.1.1. 什么是MQMQ（Message Queue）是一种跨进程的通信机制，用于传递消息。通俗点说，就是一个先进先出的数据结构。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201191317689.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201191318651.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201191318845.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201191320660.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201191444397.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201191448452.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201191452582.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201191518771.png"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201191520931.png"><meta property="article:published_time" content="2022-01-19T05:14:13.000Z"><meta property="article:modified_time" content="2022-01-19T09:01:25.141Z"><meta property="article:author" content="城雪"><meta property="article:tag" content="Java"><meta property="article:tag" content="SpringCloud"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201191317689.png"><link rel="canonical" href="https://blog.citysnow.cn/2022/01/19/SpringCloudAlibaba%EF%BC%88%E4%B8%83%EF%BC%89/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0,lang:"zh-CN"}</script><title>SpringCloudAlibaba（七） | 城雪の博客</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span><h1 class="site-title">城雪の博客</h1><span class="logo-line-after"><i></i></span></a></div><div class="site-nav-right"><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul id="menu" class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">11</span></a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">5</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>日志<span class="badge">24</span></a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"><input autocomplete="off" autocapitalize="off" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"><div id="no-result"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div></div></div></div></header><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content post posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://blog.citysnow.cn/2022/01/19/SpringCloudAlibaba%EF%BC%88%E4%B8%83%EF%BC%89/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202112062236308.jpg"><meta itemprop="name" content="城雪"><meta itemprop="description" content=""></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="城雪の博客"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">SpringCloudAlibaba（七）</h1><div class="post-meta"><i class="fa fa-thumb-tack"></i> <font color="7D26CD">置顶</font> <span class="post-meta-divider">|</span> <span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2022-01-19 13:14:13 / 修改时间：17:01:25" itemprop="dateCreated datePublished" datetime="2022-01-19T13:14:13+08:00">2022-01-19</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" itemprop="url" rel="index"><span itemprop="name">微服务</span></a> </span></span><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i> </span><span>14k</span> </span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i> </span><span>13 分钟</span></span></div></header><div class="post-body" itemprop="articleBody"><h1 id="Rocketmq–消息驱动">1. Rocketmq–消息驱动</h1><h2 id="MQ简介">1.1. MQ简介</h2><h3 id="什么是MQ">1.1.1. 什么是MQ</h3><p>MQ（Message Queue）是一种跨进程的通信机制，用于传递消息。通俗点说，就是一个先进先出的数据结构。<br><img src="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201191317689.png"></p><span id="more"></span><h3 id="MQ的应用场景">1.1.2. MQ的应用场景</h3><h4 id="异步解耦">1.1.2.1. 异步解耦</h4><p>最常见的一个场景是用户注册后，需要发送注册邮件和短信通知，以告知用户注册成功。传统的做法如下：<br><img src="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201191318651.png"><br>此架构下注册、邮件、短信三个任务全部完成后，才返回注册结果到客户端，用户才能使用账号登录。但是对于用户来说，注册功能实际只需要注册系统存储用户的账户信息后，该用户便可以登录，而后续的注册短信和邮件不是即时需要关注的步骤。<br>所以实际当数据写入注册系统后，注册系统就可以把其他的操作放入对应的消息队列 MQ 中然后马上返回用户结果，由消息队列 MQ 异步地进行这些操作。架构图如下：<br><img src="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201191318845.png"><br>异步解耦是消息队列 MQ 的主要特点，主要目的是减少请求响应时间和解耦。主要的使用场景就是将<strong>比较耗时而且不需要即时（同步）返回结果</strong>的操作作为消息放入消息队列。同时，由于使用了消息队列MQ，只要保证消息格式不变，消息的发送方和接收方并不需要彼此联系，也不需要受对方的影响，即解耦合。</p><h4 id="流量削峰">1.1.2.2. 流量削峰</h4><p>流量削峰也是消息队列 MQ 的常用场景，一般在秒杀或团队抢购(高并发)活动中使用广泛。<br>在秒杀或团队抢购活动中，由于用户请求量较大，导致流量暴增，秒杀的应用在处理如此大量的访问流量后，下游的通知系统无法承载海量的调用量，甚至会导致系统崩溃等问题而发生漏通知的情况。为解决这些问题，可在应用和下游通知系统之间加入消息队列 MQ。<br><img src="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201191320660.png"><br>秒杀处理流程如下所述：</p><ol><li>用户发起海量秒杀请求到秒杀业务处理系统。</li><li>秒杀处理系统按照秒杀处理逻辑将满足秒杀条件的请求发送至消息队列 MQ。</li><li>下游的通知系统订阅消息队列 MQ 的秒杀相关消息，再将秒杀成功的消息发送到相应用户。</li><li>用户收到秒杀成功的通知。</li></ol><h3 id="常见的MQ产品">1.1.3. 常见的MQ产品</h3><p>目前业界有很多MQ产品，比较出名的有下面这些：</p><ul><li><strong>ZeroMQ</strong><br>号称最快的消息队列系统，尤其针对大吞吐量的需求场景。扩展性好，开发比较灵活，采用C语言实现，实际上只是一个socket库的重新封装，如果做为消息队列使用，需要开发大量的代码。ZeroMQ仅提供非持久性的队列，也就是说如果down机，数据将会丢失。</li><li><strong>RabbitMQ</strong><br>使用erlang语言开发，性能较好，适合于企业级的开发。但是不利于做二次开发和维护。</li><li><strong>ActiveMQ</strong><br>历史悠久的Apache开源项目。已经在很多产品中得到应用，实现了JMS1.1规范，可以和springjms轻松融合，实现了多种协议，支持持久化到数据库，对队列数较多的情况支持不好。</li><li><strong>RocketMQ</strong><br>阿里巴巴的MQ中间件，由java语言开发，性能非常好，能够撑住双十一的大流量，而且使用起来很简单。</li><li><strong>Kafka</strong><br>Kafka是Apache下的一个子项目，是一个高性能跨语言分布式Publish/Subscribe消息队列系统，相对于ActiveMQ是一个非常轻量级的消息系统，除了性能非常好之外，还是一个工作良好的分布式系统。</li></ul><h2 id="RocketMQ入门">1.2. RocketMQ入门</h2><p>RocketMQ是阿里巴巴开源的分布式消息中间件，现在是Apache的一个顶级项目。在阿里内部使用非常广泛，已经经过了”双11”这种万亿级的消息流转</p><h3 id="RocketMQ环境搭建">1.2.1. RocketMQ环境搭建</h3><p>接下来我们先在linux平台下安装一个RocketMQ的服务</p><h4 id="环境准备">1.2.1.1. 环境准备</h4><p>下载RocketMQ <a target="_blank" rel="noopener" href="http://rocketmq.apache.org/release_notes/release-notes-4.4.0/">http://rocketmq.apache.org/release_notes/release-notes-4.4.0/</a><br>环境要求</p><ul><li>Linux 64位操作系统</li><li>64bit JDK 1.8+</li></ul><h4 id="安装RocketMQ">1.2.1.2. 安装RocketMQ</h4><ol><li>上传文件到Linux系统<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@heima rocketmq]<span class="comment"># ls /usr/local/src/</span></span><br><span class="line">rocketmq-all-4.4.0-bin-release.zip</span><br></pre></td></tr></table></figure></li><li>解压到安装目录<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@heima src]<span class="comment"># unzip rocketmq-all-4.4.0-bin-release.zip  </span></span><br><span class="line">[root@heima src]<span class="comment"># mv rocketmq-all-4.4.0-bin-release ../rocketmq</span></span><br></pre></td></tr></table></figure></li></ol><h4 id="启动RocketMQ">1.2.1.3. 启动RocketMQ</h4><ol><li>切换到安装目录<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@heima rocketmq]<span class="comment"># ls</span></span><br><span class="line">benchmark bin conf lib LICENSE NOTICE README.md</span><br></pre></td></tr></table></figure></li><li>启动NameServer<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@heima rocketmq]<span class="comment"># nohup ./bin/mqnamesrv &amp;</span></span><br><span class="line">[1] 1467</span><br><span class="line"><span class="comment"># 只要进程不报错,就应该是启动成功了,可以查看一下日志</span></span><br><span class="line">[root@heima rocketmq]<span class="comment"># tail -f /root/logs/rocketmqlogs/namesrv.log</span></span><br></pre></td></tr></table></figure></li><li>启动Broker<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编辑bin/runbroker.sh 和 bin/runserver.sh文件,修改里面的</span></span><br><span class="line"><span class="comment"># JAVA_OPT=&quot;$&#123;JAVA_OPT&#125; -server -Xms8g -Xmx8g -Xmn4g&quot;</span></span><br><span class="line"><span class="comment"># 为JAVA_OPT=&quot;$&#123;JAVA_OPT&#125; -server -Xms256m -Xmx256m -Xmn128m&quot;</span></span><br><span class="line">[root@heima rocketmq]<span class="comment"># nohup bin/mqbroker -n localhost:9876 &amp;</span></span><br><span class="line">[root@heima rocketmq]<span class="comment"># tail -f /root/logs/rocketmqlogs/broker.log</span></span><br></pre></td></tr></table></figure></li></ol><h4 id="测试RocketMQ">1.2.1.4. 测试RocketMQ</h4><ol><li>测试消息发送<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@heima rocketmq]<span class="comment"># export NAMESRV_ADDR=localhost:9876</span></span><br><span class="line">[root@heima rocketmq]<span class="comment"># bin/tools.sh</span></span><br><span class="line">org.apache.rocketmq.example.quickstart.Producer</span><br></pre></td></tr></table></figure></li><li>测试消息接收<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@heima rocketmq]<span class="comment"># export NAMESRV_ADDR=localhost:9876</span></span><br><span class="line">[root@heima rocketmq]<span class="comment"># bin/tools.sh</span></span><br><span class="line">org.apache.rocketmq.example.quickstart.Consumer</span><br></pre></td></tr></table></figure></li></ol><h4 id="关闭RocketMQ">1.2.1.5. 关闭RocketMQ</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@heima rocketmq]<span class="comment"># bin/mqshutdown broker</span></span><br><span class="line">[root@heima rocketmq]<span class="comment"># bin/mqshutdown namesrv</span></span><br></pre></td></tr></table></figure><h3 id="RocketMQ的架构及概念">1.2.2. RocketMQ的架构及概念</h3><p><img src="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201191444397.png"><br>如上图所示，整体可以分成4个角色，分别是：NameServer，Broker，Producer，Consumer。</p><ul><li>Broker(邮递员)<br>Broker是RocketMQ的核心，负责消息的接收，存储，投递等功能</li><li>NameServer(邮局)<br>消息队列的协调者，Broker向它注册路由信息，同时Producer和Consumer向其获取路由信息</li><li>Producer(寄件人)<br>消息的生产者，需要从NameServer获取Broker信息，然后与Broker建立连接，向Broker发送消息</li><li>Consumer(收件人)<br>消息的消费者，需要从NameServer获取Broker信息，然后与Broker建立连接，从Broker获取消息</li><li>Topic(地区)<br>用来区分不同类型的消息，发送和接收消息前都需要先创建Topic，针对Topic来发送和接收消息</li><li>Message Queue(邮件)<br>为了提高性能和吞吐量，引入了Message Queue，一个Topic可以设置一个或多个Message Queue，这样消息就可以并行往各个Message Queue发送消息，消费者也可以并行的从多个Message Queue读取消息</li><li>Message<br>Message 是消息的载体。</li><li>Producer Group<br>生产者组，简单来说就是多个发送同一类消息的生产者称之为一个生产者组。</li><li>Consumer Group<br>消费者组，消费同一类消息的多个 consumer 实例组成一个消费者组。</li></ul><h3 id="RocketMQ控制台安装">1.2.3. RocketMQ控制台安装</h3><ol><li>下载<br>在git上下载下面的工程 rocketmq-console-1.0.0<br><a target="_blank" rel="noopener" href="https://github.com/apache/rocketmq-externals/releases">https://github.com/apache/rocketmq-externals/releases</a></li><li>修改配置文件<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改配置文件 rocketmq-console\src\main\resources\application.properties</span></span><br><span class="line">server.port=7777 <span class="comment">#项目启动后的端口号</span></span><br><span class="line">rocketmq.config.namesrvAddr=192.168.109.131:9876 <span class="comment">#nameserv的地址，注意防火墙要开启9876端口</span></span><br></pre></td></tr></table></figure></li><li>打成jar包，并启动<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入控制台项目，将工程打成jar包</span></span><br><span class="line">mvn clean package -Dmaven.test.skip=<span class="literal">true</span></span><br><span class="line"><span class="comment"># 启动控制台</span></span><br><span class="line">java -jar target/rocketmq-console-ng-1.0.0.jar</span><br></pre></td></tr></table></figure></li><li>访问控制台<br><img src="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201191448452.png"></li></ol><h2 id="消息发送和接收演示">1.3. 消息发送和接收演示</h2><p>接下来我们使用Java代码来演示消息的发送和接收</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.apache.rocketmq&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;rocketmq-spring-boot-starter&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;2.0.2&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure><h3 id="发送消息">1.3.1. 发送消息</h3><p>消息发送步骤:</p><ol><li>创建消息生产者, 指定生产者所属的组名</li><li>指定Nameserver地址</li><li>启动生产者</li><li>创建消息对象，指定主题、标签和消息体</li><li>发送消息</li><li>关闭生产者</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">//发送消息</span><br><span class="line">public class RocketMQSendTest &#123;</span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">        //1. 创建消息生产者, 指定生产者所属的组名</span><br><span class="line">        DefaultMQProducer producer = new DefaultMQProducer(<span class="string">&quot;myproducer-group&quot;</span>);</span><br><span class="line">        //2. 指定Nameserver地址</span><br><span class="line">        producer.setNamesrvAddr(<span class="string">&quot;192.168.109.131:9876&quot;</span>);</span><br><span class="line">        //3. 启动生产者</span><br><span class="line">        producer.start();</span><br><span class="line">        //4. 创建消息对象，指定主题、标签和消息体</span><br><span class="line">        Message msg = new Message(<span class="string">&quot;myTopic&quot;</span>, <span class="string">&quot;myTag&quot;</span>, (<span class="string">&quot;RocketMQ Message&quot;</span>).getBytes());</span><br><span class="line">        //5. 发送消息</span><br><span class="line">        SendResult sendResult = producer.send(msg,10000);</span><br><span class="line">        System.out.println(sendResult);</span><br><span class="line">        //6. 关闭生产者</span><br><span class="line">        producer.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="接收消息">1.3.2. 接收消息</h3><p>消息接收步骤:</p><ol><li>创建消息消费者, 指定消费者所属的组名</li><li>指定Nameserver地址</li><li>指定消费者订阅的主题和标签</li><li>设置回调函数，编写处理消息的方法</li><li>启动消息消费者</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">//接收消息</span><br><span class="line">public class RocketMQReceiveTest &#123;</span><br><span class="line">    public static void main(String[] args) throws MQClientException &#123;</span><br><span class="line">    //1. 创建消息消费者, 指定消费者所属的组名</span><br><span class="line">        DefaultMQPushConsumer consumer = new DefaultMQPushConsumer(<span class="string">&quot;myconsumergroup&quot;</span>);</span><br><span class="line">        //2. 指定Nameserver地址</span><br><span class="line">        consumer.setNamesrvAddr(<span class="string">&quot;192.168.109.131:9876&quot;</span>);</span><br><span class="line">        //3. 指定消费者订阅的主题和标签</span><br><span class="line">        consumer.subscribe(<span class="string">&quot;myTopic&quot;</span>, <span class="string">&quot;*&quot;</span>);</span><br><span class="line">        //4. 设置回调函数，编写处理消息的方法</span><br><span class="line">        consumer.registerMessageListener(new <span class="function"><span class="title">MessageListenerConcurrently</span></span>() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public ConsumeConcurrentlyStatus consumeMessage(List&lt;MessageExt&gt; msgs,ConsumeConcurrentlyContext context) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;Receive New Messages: &quot;</span> + msgs);</span><br><span class="line">                //返回消费状态</span><br><span class="line">                <span class="built_in">return</span> ConsumeConcurrentlyStatus.CONSUME_SUCCESS;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        //5. 启动消息消费者</span><br><span class="line">        consumer.start();</span><br><span class="line">        System.out.println(<span class="string">&quot;Consumer Started.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="案例">1.4. 案例</h2><p>接下来我们模拟一种场景: 下单成功之后，向下单用户发送短信。设计图如下：<br><img src="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201191452582.png"></p><h3 id="订单微服务发送消息">1.4.1. 订单微服务发送消息</h3><ol><li>在shop-order 中添加rocketmq的依赖<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--rocketmq--&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.apache.rocketmq&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;rocketmq-spring-boot-starter&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;2.0.2&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.apache.rocketmq&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;rocketmq-client&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;4.4.0&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure></li><li>添加配置<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">rocketmq:</span><br><span class="line">    name-server: 192.168.109.131:9876 <span class="comment">#rocketMQ服务的地址</span></span><br><span class="line">    producer:</span><br><span class="line">        group: shop-order <span class="comment"># 生产者组</span></span><br></pre></td></tr></table></figure></li><li>编写测试代码<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">@RestController</span><br><span class="line">@Slf4j</span><br><span class="line">public class OrderController2 &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private OrderService orderService;</span><br><span class="line">    @Autowired</span><br><span class="line">    private ProductService productService;</span><br><span class="line">    @Autowired</span><br><span class="line">    private RocketMQTemplate rocketMQTemplate;</span><br><span class="line"></span><br><span class="line">    //准备买1件商品</span><br><span class="line">    @GetMapping(<span class="string">&quot;/order/prod/&#123;pid&#125;&quot;</span>)</span><br><span class="line">    public Order order(@PathVariable(<span class="string">&quot;pid&quot;</span>) Integer pid) &#123;</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">&quot;&gt;&gt;客户下单,这时候要调用商品微服务查询商品信息&quot;</span>);</span><br><span class="line">        //通过fegin调用商品微服务</span><br><span class="line">        Product product = productService.findByPid(pid);</span><br><span class="line">        <span class="keyword">if</span> (product == null)&#123;</span><br><span class="line">            Order order = new Order();</span><br><span class="line">            order.setPname(<span class="string">&quot;下单失败&quot;</span>);</span><br><span class="line">            <span class="built_in">return</span> order;</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(<span class="string">&quot;&gt;&gt;商品信息,查询结果:&quot;</span> + JSON.toJSONString(product));</span><br><span class="line">        Order order = new Order();</span><br><span class="line">        order.setUid(1);</span><br><span class="line">        order.setUsername(<span class="string">&quot;测试用户&quot;</span>);</span><br><span class="line">        order.setPid(product.getPid());</span><br><span class="line">        order.setPname(product.getPname());</span><br><span class="line">        order.setPprice(product.getPprice());</span><br><span class="line">        order.setNumber(1);</span><br><span class="line">        orderService.save(order);</span><br><span class="line">        //下单成功之后,将消息放到mq中</span><br><span class="line">        rocketMQTemplate.convertAndSend(<span class="string">&quot;order-topic&quot;</span>, order);</span><br><span class="line">        <span class="built_in">return</span> order;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h3 id="用户微服务订阅消息">1.4.2. 用户微服务订阅消息</h3><ol><li>修改shop-user 模块配置<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span><br><span class="line">&lt;project xmlns=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span><br><span class="line">xmlns:xsi=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="line">xsi:schemaLocation=<span class="string">&quot;http://maven.apache.org/POM/4.0.0</span></span><br><span class="line"><span class="string">http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span><br><span class="line">    &lt;parent&gt;</span><br><span class="line">        &lt;artifactId&gt;springcloud-alibaba&lt;/artifactId&gt;</span><br><span class="line">        &lt;groupId&gt;com.itheima&lt;/groupId&gt;</span><br><span class="line">        &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;</span><br><span class="line">    &lt;/parent&gt;</span><br><span class="line">    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;</span><br><span class="line">    &lt;artifactId&gt;shop-user&lt;/artifactId&gt;</span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.itheima&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;shop-common&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-cloud-starter-alibaba-nacosdiscovery&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.apache.rocketmq&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;rocketmq-spring-boot-starter&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;2.0.2&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.apache.rocketmq&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;rocketmq-client&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;4.4.0&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">    &lt;/dependencies&gt;</span><br><span class="line">&lt;/project&gt;</span><br></pre></td></tr></table></figure></li><li>修改主类<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@SpringBootApplication</span><br><span class="line">@EnableDiscoveryClient</span><br><span class="line">public class UserApplication &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        SpringApplication.run(UserApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>修改配置文件<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">server:</span><br><span class="line">    port: 8071</span><br><span class="line">spring:</span><br><span class="line">    application:</span><br><span class="line">        name: service-user</span><br><span class="line">    datasource:</span><br><span class="line">        driver-class-name: com.mysql.jdbc.Driver</span><br><span class="line">        url: jdbc:mysql:///shop?serverTimezone=UTC&amp;useUnicode=<span class="literal">true</span>&amp;characterEncoding=utf-8&amp;useSSL=<span class="literal">true</span></span><br><span class="line">        username: root</span><br><span class="line">        password: root</span><br><span class="line">    jpa:</span><br><span class="line">        properties:</span><br><span class="line">            hibernate:</span><br><span class="line">                hbm2ddl:</span><br><span class="line">                    auto: update</span><br><span class="line">                dialect: org.hibernate.dialect.MySQL5InnoDBDialect</span><br><span class="line">    cloud:</span><br><span class="line">        nacos:</span><br><span class="line">            discovery:</span><br><span class="line">                server-addr: 127.0.0.1:8848</span><br><span class="line">    rocketmq:</span><br><span class="line">        name-server: 192.168.109.131:9876</span><br></pre></td></tr></table></figure></li><li>编写消息接收服务<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">//发送短信的服务</span><br><span class="line">@Slf4j</span><br><span class="line">@Service</span><br><span class="line">@RocketMQMessageListener(consumerGroup = <span class="string">&quot;shop-user&quot;</span>, topic = <span class="string">&quot;order-topic&quot;</span>)</span><br><span class="line">public class SmsService implements RocketMQListener&lt;Order&gt; &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public void onMessage(Order order) &#123;</span><br><span class="line">        log.info(<span class="string">&quot;收到一个订单信息&#123;&#125;,接下来发送短信&quot;</span>, JSON.toJSONString(order));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li>启动服务，执行下单操作，观看后台输出</li></ol><h2 id="发送不同类型的消息">1.5. 发送不同类型的消息</h2><h3 id="普通消息">1.5.1. 普通消息</h3><p>RocketMQ提供三种方式来发送普通消息：可靠同步发送、可靠异步发送和单向发送。</p><p><strong>可靠同步发送</strong></p><blockquote><p>同步发送是指消息发送方发出数据后，会在收到接收方发回响应之后才发下一个数据包的通讯方式。<br>此种方式应用场景非常广泛，例如重要通知邮件、报名短信通知、营销短信系统等。</p></blockquote><p><strong>可靠异步发送</strong></p><blockquote><p>异步发送是指发送方发出数据后，不等接收方发回响应，接着发送下个数据包的通讯方式。发送方通过回调接口接收服务器响应，并对响应结果进行处理。<br>异步发送一般用于链路耗时较长，对 RT 响应时间较为敏感的业务场景，例如用户视频上传后通知启动转码服务，转码完成后通知推送转码结果等。</p></blockquote><p><strong>单向发送</strong></p><blockquote><p>单向发送是指发送方只负责发送消息，不等待服务器回应且没有回调函数触发，即只发送请求不等待应答。<br>适用于某些耗时非常短，但对可靠性要求并不高的场景，例如日志收集。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--依赖--&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;junit&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;junit&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">//测试</span><br><span class="line">@RunWith(SpringRunner.class)</span><br><span class="line">@SpringBootTest(classes = OrderApplication.class)</span><br><span class="line">public class MessageTypeTest &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private RocketMQTemplate rocketMQTemplate;</span><br><span class="line"></span><br><span class="line">    //同步消息</span><br><span class="line">    @Test</span><br><span class="line">    public void <span class="function"><span class="title">testSyncSend</span></span>() &#123;</span><br><span class="line">        //参数一: topic， 如果想添加tag 可以使用<span class="string">&quot;topic:tag&quot;</span>的写法</span><br><span class="line">        //参数二: 消息内容</span><br><span class="line">        SendResult sendResult = rocketMQTemplate.syncSend(<span class="string">&quot;test-topic-1&quot;</span>, <span class="string">&quot;这是一条同步消息&quot;</span>);</span><br><span class="line">        System.out.println(sendResult);</span><br><span class="line">    &#125;</span><br><span class="line">    //异步消息</span><br><span class="line">    @Test</span><br><span class="line">    public void testAsyncSend() throws InterruptedException &#123;</span><br><span class="line">        public void <span class="function"><span class="title">testSyncSendMsg</span></span>() &#123;</span><br><span class="line">            //参数一: topic, 如果想添加tag 可以使用<span class="string">&quot;topic:tag&quot;</span>的写法</span><br><span class="line">            //参数二: 消息内容</span><br><span class="line">            //参数三: 回调函数, 处理返回结果</span><br><span class="line">            rocketMQTemplate.asyncSend(<span class="string">&quot;test-topic-1&quot;</span>, <span class="string">&quot;这是一条异步消息&quot;</span>, new <span class="function"><span class="title">SendCallback</span></span>() &#123;</span><br><span class="line">                @Override</span><br><span class="line">                public void onSuccess(SendResult sendResult) &#123;</span><br><span class="line">                    System.out.println(sendResult);</span><br><span class="line">                &#125;</span><br><span class="line">                @Override</span><br><span class="line">                public void onException(Throwable throwable) &#123;</span><br><span class="line">                    System.out.println(throwable);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            //让线程不要终止</span><br><span class="line">            Thread.sleep(30000000);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //单向消息</span><br><span class="line">    @Test</span><br><span class="line">    public void <span class="function"><span class="title">testOneWay</span></span>() &#123;</span><br><span class="line">        rocketMQTemplate.sendOneWay(<span class="string">&quot;test-topic-1&quot;</span>, <span class="string">&quot;这是一条单向消息&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>三种发送方式的对比</strong></p><table><thead><tr><th>发送方式</th><th>发送 TPS</th><th>发送结果反馈</th><th>可靠性</th></tr></thead><tbody><tr><td>同步发送</td><td>快</td><td>有</td><td>不丢失</td></tr><tr><td>异步发送</td><td>快</td><td>有</td><td>不丢失</td></tr><tr><td>单向发送</td><td>最快</td><td>无</td><td>可能丢失</td></tr></tbody></table><h3 id="顺序消息">1.5.2. 顺序消息</h3><p>顺序消息是消息队列提供的一种严格按照顺序来发布和消费的消息类型。<br><img src="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201191518771.png"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//同步顺序消息[异步顺序 单向顺序写法类似]</span><br><span class="line">public void <span class="function"><span class="title">testSyncSendOrderly</span></span>() &#123;</span><br><span class="line">    //第三个参数用于队列的选择</span><br><span class="line">    rocketMQTemplate.syncSendOrderly(<span class="string">&quot;test-topic-1&quot;</span>, <span class="string">&quot;这是一条异步顺序消息&quot;</span>,<span class="string">&quot;xxxx&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="事务消息">1.5.3. 事务消息</h3><p>RocketMQ提供了事务消息，通过事务消息就能达到分布式事务的最终一致。</p><p><strong>事务消息交互流程</strong>:<br><img src="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202201191520931.png"></p><p><strong>两个概念</strong>:</p><ul><li>半事务消息：暂不能投递的消息，发送方已经成功地将消息发送到了RocketMQ服务端，但是服务端未收到生产者对该消息的二次确认，此时该消息被标记成“暂不能投递”状态，处于该种状态下的消息即半事务消息。</li><li>消息回查：由于网络闪断、生产者应用重启等原因，导致某条事务消息的二次确认丢失，RocketMQ服务端通过扫描发现某条消息长期处于“半事务消息”时，需要主动向消息生产者询问该消息的最终状态（Commit 或是 Rollback），该询问过程即消息回查。</li></ul><p><strong>事务消息发送步骤</strong>:</p><ol><li>发送方将半事务消息发送至RocketMQ服务端。</li><li>RocketMQ服务端将消息持久化之后，向发送方返回Ack确认消息已经发送成功，此时消息为半事务消息。</li><li>发送方开始执行本地事务逻辑。</li><li>发送方根据本地事务执行结果向服务端提交二次确认（Commit 或是 Rollback），服务端收到Commit 状态则将半事务消息标记为可投递，订阅方最终将收到该消息；服务端收到 Rollback 状态则删除半事务消息，订阅方将不会接受该消息。</li></ol><p><strong>事务消息回查步骤</strong>:</p><ol><li>在断网或者是应用重启的特殊情况下，上述步骤4提交的二次确认最终未到达服务端，经过固定时间后服务端将对该消息发起消息回查。</li><li>发送方收到消息回查后，需要检查对应消息的本地事务执行的最终结果。</li><li>发送方根据检查得到的本地事务的最终状态再次提交二次确认，服务端仍按照步骤4对半事务消息进行操作。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">//事物日志</span><br><span class="line">@Entity(name = <span class="string">&quot;shop_txlog&quot;</span>)</span><br><span class="line">@Data</span><br><span class="line">public class TxLog &#123;</span><br><span class="line">    @Id</span><br><span class="line">    private String txLogId;</span><br><span class="line">    private String content;</span><br><span class="line">    private Date date;</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line">@Service</span><br><span class="line">public class OrderServiceImpl4 &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private OrderDao orderDao;</span><br><span class="line">    @Autowired</span><br><span class="line">    private TxLogDao txLogDao;</span><br><span class="line">    @Autowired</span><br><span class="line">    private RocketMQTemplate rocketMQTemplate;</span><br><span class="line"></span><br><span class="line">    public void createOrderBefore(Order order) &#123;</span><br><span class="line">        String txId = UUID.randomUUID().toString();</span><br><span class="line">        //发送半事务消息</span><br><span class="line">        rocketMQTemplate.sendMessageInTransaction(<span class="string">&quot;tx_producer_group&quot;</span>, <span class="string">&quot;tx_topic&quot;</span>, MessageBuilder.withPayload(order).setHeader(<span class="string">&quot;txId&quot;</span>, txId).build(), order);</span><br><span class="line">    &#125;</span><br><span class="line">    //本地事物</span><br><span class="line">    @Transactional</span><br><span class="line">    public void createOrder(String txId, Order order) &#123;</span><br><span class="line">        //本地事物代码</span><br><span class="line">        orderDao.save(order);</span><br><span class="line">        //记录日志到数据库,回查使用</span><br><span class="line">        TxLog txLog = new TxLog();</span><br><span class="line">        txLog.setTxLogId(txId);</span><br><span class="line">        txLog.setContent(<span class="string">&quot;事物测试&quot;</span>);</span><br><span class="line">        txLog.setDate(new Date());</span><br><span class="line">        txLogDao.save(txLog);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line">@RocketMQTransactionListener(txProducerGroup = <span class="string">&quot;tx_producer_group&quot;</span>)</span><br><span class="line">public class OrderServiceImpl4Listener implements RocketMQLocalTransactionListener &#123;</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private TxLogDao txLogDao;</span><br><span class="line">    @Autowired</span><br><span class="line">    private OrderServiceImpl4 orderServiceImpl4;</span><br><span class="line"></span><br><span class="line">    //执行本地事物</span><br><span class="line">    @Override</span><br><span class="line">    public RocketMQLocalTransactionState executeLocalTransaction(Message msg, Object arg) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            //本地事物</span><br><span class="line">            orderServiceImpl4.createOrder((String)msg.getHeaders().get(<span class="string">&quot;txId&quot;</span>), (Order) arg);</span><br><span class="line">            <span class="built_in">return</span> RocketMQLocalTransactionState.COMMIT;</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            <span class="built_in">return</span> RocketMQLocalTransactionState.ROLLBACK;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    //消息回查</span><br><span class="line">    @Override</span><br><span class="line">    public RocketMQLocalTransactionState checkLocalTransaction(Message msg) &#123;</span><br><span class="line">        //查询日志记录</span><br><span class="line">        TxLog txLog = txLogDao.findById((String)msg.getHeaders().get(<span class="string">&quot;txId&quot;</span>)).get();</span><br><span class="line">        <span class="keyword">if</span> (txLog == null) &#123;</span><br><span class="line">            <span class="built_in">return</span> RocketMQLocalTransactionState.COMMIT;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">return</span> RocketMQLocalTransactionState.ROLLBACK;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ol><h2 id="消息消费要注意的细节">1.6. 消息消费要注意的细节</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@RocketMQMessageListener(</span><br><span class="line">    consumerGroup = <span class="string">&quot;shop&quot;</span>,//消费者分组</span><br><span class="line">    topic = <span class="string">&quot;order-topic&quot;</span>,//要消费的主题</span><br><span class="line">    consumeMode = ConsumeMode.CONCURRENTLY, //消费模式:无序和有序</span><br><span class="line">    messageModel = MessageModel.CLUSTERING, //消息模式:广播和集群,默认是集群</span><br><span class="line">)</span><br><span class="line">public class SmsService implements RocketMQListener&lt;Order&gt; &#123;&#125;</span><br></pre></td></tr></table></figure><p>RocketMQ支持两种消息模式:</p><ul><li>广播消费: 每个消费者实例都会收到消息,也就是一条消息可以被每个消费者实例处理；</li><li>集群消费: 一条消息只能被一个消费者实例消费</li></ul></div><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者： </strong>城雪</li><li class="post-copyright-link"><strong>本文链接：</strong> <a href="https://blog.citysnow.cn/2022/01/19/SpringCloudAlibaba%EF%BC%88%E4%B8%83%EF%BC%89/" title="SpringCloudAlibaba（七）">https://blog.citysnow.cn/2022/01/19/SpringCloudAlibaba（七）/</a></li><li class="post-copyright-license"><strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div><footer class="post-footer"><div class="post-tags"><a href="/tags/Java/" rel="tag"><i class="fa fa-tag"></i> Java</a> <a href="/tags/SpringCloud/" rel="tag"><i class="fa fa-tag"></i> SpringCloud</a></div><div class="post-nav"><div class="post-nav-item"><a href="/2022/01/19/SpringCloudAlibaba%EF%BC%88%E4%B9%9D%EF%BC%89/" rel="prev" title="SpringCloudAlibaba（九）"><i class="fa fa-chevron-left"></i> SpringCloudAlibaba（九）</a></div><div class="post-nav-item"><a href="/2022/03/23/Euserv%20%E6%90%AD%E5%BB%BA%E5%AE%9D%E5%A1%94%E9%9D%A2%E6%9D%BF/" rel="next" title="Euserv 搭建宝塔面板">Euserv 搭建宝塔面板 <i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><script>window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span> <span class="toggle-line toggle-line-middle"></span> <span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Rocketmq%E2%80%93%E6%B6%88%E6%81%AF%E9%A9%B1%E5%8A%A8"><span class="nav-text">1. Rocketmq–消息驱动</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#MQ%E7%AE%80%E4%BB%8B"><span class="nav-text">1.1. MQ简介</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFMQ"><span class="nav-text">1.1.1. 什么是MQ</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MQ%E7%9A%84%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="nav-text">1.1.2. MQ的应用场景</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BC%82%E6%AD%A5%E8%A7%A3%E8%80%A6"><span class="nav-text">1.1.2.1. 异步解耦</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B5%81%E9%87%8F%E5%89%8A%E5%B3%B0"><span class="nav-text">1.1.2.2. 流量削峰</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E7%9A%84MQ%E4%BA%A7%E5%93%81"><span class="nav-text">1.1.3. 常见的MQ产品</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RocketMQ%E5%85%A5%E9%97%A8"><span class="nav-text">1.2. RocketMQ入门</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#RocketMQ%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="nav-text">1.2.1. RocketMQ环境搭建</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="nav-text">1.2.1.1. 环境准备</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%89%E8%A3%85RocketMQ"><span class="nav-text">1.2.1.2. 安装RocketMQ</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%90%AF%E5%8A%A8RocketMQ"><span class="nav-text">1.2.1.3. 启动RocketMQ</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95RocketMQ"><span class="nav-text">1.2.1.4. 测试RocketMQ</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%B3%E9%97%ADRocketMQ"><span class="nav-text">1.2.1.5. 关闭RocketMQ</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RocketMQ%E7%9A%84%E6%9E%B6%E6%9E%84%E5%8F%8A%E6%A6%82%E5%BF%B5"><span class="nav-text">1.2.2. RocketMQ的架构及概念</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RocketMQ%E6%8E%A7%E5%88%B6%E5%8F%B0%E5%AE%89%E8%A3%85"><span class="nav-text">1.2.3. RocketMQ控制台安装</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81%E5%92%8C%E6%8E%A5%E6%94%B6%E6%BC%94%E7%A4%BA"><span class="nav-text">1.3. 消息发送和接收演示</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF"><span class="nav-text">1.3.1. 发送消息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8E%A5%E6%94%B6%E6%B6%88%E6%81%AF"><span class="nav-text">1.3.2. 接收消息</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A1%88%E4%BE%8B"><span class="nav-text">1.4. 案例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AE%A2%E5%8D%95%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF"><span class="nav-text">1.4.1. 订单微服务发送消息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%94%A8%E6%88%B7%E5%BE%AE%E6%9C%8D%E5%8A%A1%E8%AE%A2%E9%98%85%E6%B6%88%E6%81%AF"><span class="nav-text">1.4.2. 用户微服务订阅消息</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%91%E9%80%81%E4%B8%8D%E5%90%8C%E7%B1%BB%E5%9E%8B%E7%9A%84%E6%B6%88%E6%81%AF"><span class="nav-text">1.5. 发送不同类型的消息</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%99%AE%E9%80%9A%E6%B6%88%E6%81%AF"><span class="nav-text">1.5.1. 普通消息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A1%BA%E5%BA%8F%E6%B6%88%E6%81%AF"><span class="nav-text">1.5.2. 顺序消息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%8B%E5%8A%A1%E6%B6%88%E6%81%AF"><span class="nav-text">1.5.3. 事务消息</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B6%88%E6%81%AF%E6%B6%88%E8%B4%B9%E8%A6%81%E6%B3%A8%E6%84%8F%E7%9A%84%E7%BB%86%E8%8A%82"><span class="nav-text">1.6. 消息消费要注意的细节</span></a></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="城雪" src="https://cdn.jsdelivr.net/gh/TheCitySnow/blog-img/202112062236308.jpg"><p class="site-author-name" itemprop="name">城雪</p><div class="site-description" itemprop="description"></div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">24</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">11</span> <span class="site-state-item-name">标签</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">5</span> <span class="site-state-item-name">分类</span></a></div></nav></div></div><div class="back-to-top motion-element"><i class="fa fa-arrow-up"></i> <span>0%</span></div><script type="text/javascript" charset="utf-8" src="/js/tagcloud.js"></script><script type="text/javascript" charset="utf-8" src="/js/tagcanvas.js"></script><div class="widget-wrap"><h3 class="widget-title"></h3><div id="myCanvasContainer" class="widget tagcloud"><canvas width="250" height="250" id="resCanvas"><ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/CMD/" rel="tag">CMD</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ES6/" rel="tag">ES6</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/" rel="tag">Java</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MyBatis/" rel="tag">MyBatis</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mysql/" rel="tag">Mysql</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring/" rel="tag">Spring</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpringBoot/" rel="tag">SpringBoot</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpringCloud/" rel="tag">SpringCloud</a><span class="tag-list-count">12</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vue/" rel="tag">Vue</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" rel="tag">多线程</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AE%9D%E5%A1%94%E9%9D%A2%E6%9D%BF/" rel="tag">宝塔面板</a><span class="tag-list-count">1</span></li></ul></canvas></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2022</span> <span class="with-love"><i class="fa fa-music"></i> </span><span class="author" itemprop="copyrightHolder">城雪</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-chart-area"></i> </span><span title="站点总字数">174k</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-coffee"></i> </span><span title="站点阅读时长">2:38</span></div></div></footer></div><script src="/lib/anime.min.js"></script><script src="//cdn.jsdelivr.net/gh/theme-next/theme-next-pjax@0/pjax.min.js"></script><script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script><script>var pjax = new Pjax({
  selectors: [
    'head title',
    '#page-configurations',
    '.content-wrap',
    '.post-toc-wrap',
    '.languages',
    '#pjax'
  ],
  switches: {
    '.post-toc-wrap': Pjax.switches.innerHTML
  },
  analytics: false,
  cacheBust: false,
  scrollTo : !CONFIG.bookmark.enable
});

window.addEventListener('pjax:success', () => {
  document.querySelectorAll('script[data-pjax], script#page-configurations, #pjax script').forEach(element => {
    var code = element.text || element.textContent || element.innerHTML || '';
    var parent = element.parentNode;
    parent.removeChild(element);
    var script = document.createElement('script');
    if (element.id) {
      script.id = element.id;
    }
    if (element.className) {
      script.className = element.className;
    }
    if (element.type) {
      script.type = element.type;
    }
    if (element.src) {
      script.src = element.src;
      // Force synchronous loading of peripheral JS.
      script.async = false;
    }
    if (element.dataset.pjax !== undefined) {
      script.dataset.pjax = '';
    }
    if (code !== '') {
      script.appendChild(document.createTextNode(code));
    }
    parent.appendChild(script);
  });
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  NexT.utils.updateSidebarPosition();
});</script><script src="/js/common.js"></script><script src="/js/local-search.js"></script><div id="pjax"></div><script color="64, 64, 64" type="text/javascript" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script></body></html>